@page "/observability/grafana"

	<Breadcrumbs NavName="Grafana"
							 ParentLinkName="Observability"
							 ParentLinkUrl="/observability"
							 ShowGetStarted=false />
<Tutorial>
	<Title>Using Grafana for app container metrics, distributed tracing, and observability</Title>
	<Description>This tutorial takes you creating a simple Steeltoe app with actuators, logging, and distributed tracing. With that app running you then export the data to an instance of Prometheus and visualize things in a Grafana dashboard.</Description>
	<TutorialSteps>
    <div class="row">
			<div class="col-12 getting-started-header">First, <b>clone to accompanying repo</b> that contains all the needed assets</div>
		</div>
    <div class="row">
			<div class="col-12 getting-started-ordered-list">
				<ol>
					<li>
						<TabSet>
							<Tab Title="Local">
								<code class="inline">git clone https://github.com/steeltoeoss-incubator/observability.git</code>
                <code class="inline">cd observability/grafana</code>
							</Tab>
						</TabSet>
					</li>
          <li>
            Have a look at what things are provided
            <code class="inline">ls</code>
<pre><code>Name                Description
----                ----
dashboard.json      The Grafana dashboard definition
dashboard.yml       Grafana dashboard provider
datasource.yml      Grafana datasource definition for prometheus and influxdb 
docker-compose.yml  Docker file to start all containers
prometheus.yml      Prometheus scrape configs
telegraf.conf       Telegraf inputs and output configuration
</code></pre>
          </li>
				</ol>
			</div>
		</div>
    <div class="row">
			<div class="col-12 getting-started-header">Next, <b>create a .NET Core WebAPI</b> with the correct Steeltoe dependencies</div>
		</div>
		<div class="row">
			<div class="col-12 getting-started-ordered-list">
				<ol>
					<li>
						<Steeltoe.Client.Components.AppSettingsTab.Initiallizr ImageName="actuators.png" DependencyName="Actuators, DynamicLogging" ProjectName="@ProjectName" />
					</li>
					<li>Extract the zipped project into <code>./src</code> and open in your IDE of choice (we use Visual Studio)</li>
					<li>
						Add the other needed actuators in <b>startup.cs</b>
<pre><code>using Steeltoe.Management.Endpoint.Metrics;

...

public class Startup
{
  ...

  public void ConfigureServices(IServiceCollection services)
  {
  
    ...
  
    services.AddPrometheusActuator(Configuration);
    services.AddMetricsActuator(Configuration);
    services.AddDistributedTracing(Configuration);
    services.AddZipkinExporter(Configuration);

    ...

  }
 
  public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
  {

    ...

		app.UsePrometheusActuator();
		app.UseMetricsActuator();
		app.UseTracingExporter();

    ...

  }
}</code></pre>
					</li>
					<li>
						Set the actuator path and exposure addresses in <b>appsettings.json</b>
						<TabSet>
							<Tab Title="Local">
								<pre><code>{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "System": "Information",
      "Microsoft": "Information"
    }
  },
  "spring": {
    "application": {
      "name": "Grafana_demo_app"
    }
  },
  "management": {
    "endpoints": {
      "actuator": {
        "exposure": {
          "include": [ "*" ]
        }
      },
      "path": "/actuators",
      "cloudfoundry": {
        "validateCertificates": false
      }
    },
    "metrics": {
      "exporter": {
        "cloudfoundry": {
          "validateCertificates": false
        }
      }
    },
    "tracing": {
      "alwaysSample": true,
      "useShortTraceIds ": true,
      "exporter": {
        "zipkin": {
          "endpoint": "http://zipkin:9411/api/v2/spans",
          "validateCertificates": false
        }
      }
    }
  }
}</code></pre>
							</Tab>
						</TabSet>
					</li>
				</ol>
			</div>
		</div>
    <div class="row">
			<div class="col-12 getting-started-header">Next, <b>deploy everything</b> with docker compose</div>
		</div>
		<div class="row">
			<div class="col-12 getting-started-ordered-list">
        <TabSet>
				  <Steeltoe.Client.Components.RunAppTab.DockerCompose>
            <AdditionalSteps><Note><Message>Confirm everything started successfully by running <code>docker-compose ps</code>. There should be 6 containers running named: steeltoe-app, zipkin, prometheus, influxdb, telegraf, grafana.</Message></Note></AdditionalSteps>
          </Steeltoe.Client.Components.RunAppTab.DockerCompose>
			  </TabSet>
			</div>
		</div>
    <div class="row">
			<div class="col-12 getting-started-header">Finally, <b>navigate to Grafana</b> to see the default dashboard showing the app's metrics.</div>
		</div>
		<div class="row">
			<div class="col-12 getting-started-ordered-list">
        <Note><Message>The default username is <code>admin</code> and the password is <code>admin.</code></Message></Note>
        <TabSet>
				  <Tab Title="Local">
            Grafana is available at <Href href="http://localhost:3000" target="_blank">http://localhost:3000</Href>.
          </Tab>
			  </TabSet>
      </div>
		</div>
	</TutorialSteps>
</Tutorial>

@code
{
	//private string ServiceName = "grafana";
	//private string InstanceName = "mygrafanaservice";
	private string ProjectName = "Grafana_Observability";
}