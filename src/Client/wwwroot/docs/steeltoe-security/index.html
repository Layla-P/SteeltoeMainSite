<!DOCTYPE html>
<!-- saved from url=(0048) -->
<html class="gr__steeltoe_io">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta content="IE=edge" http-equiv="X-UA-Compatible">

	<meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">

	<!-- Use title if it's in the page YAML frontmatter -->
	<link href="images/favicon.png" rel="icon" type="image/png">
	<link rel="stylesheet" href="/stylesheets/css.css">
	<link href="/stylesheets/site.css" rel="stylesheet">
	<link href="/stylesheets/tocbot.css" rel="stylesheet">
</head>


<body class="docs docs_steeltoe-security docs_steeltoe-security_index" data-gr-c-s-loaded="true">
	<div class="max-width-4 mx-auto">
		<div class="">
			<div class="sm-flex">
				<div class="col-12 sm-col-3 sm-pr3">

					<div id="toc" class="">
						<div class="toc-link border-bottom border-silver js-toc"><ul class="toc-list "><li class="toc-list-item"><a href="#0-0-initialize-dev-environment" class="toc-link node-name--H1  is-active-link">0.0 Initialize Dev Environment</a></li><li class="toc-list-item"><a href="#1-0-single-sign-on-with-oauth2" class="toc-link node-name--H1 ">1.0 Single Sign-on with OAuth2</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#1-1-quick-start" class="toc-link node-name--H2 ">1.1 Quick Start</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#1-1-1-locate-sample" class="toc-link node-name--H3 ">1.1.1 Locate Sample</a></li><li class="toc-list-item"><a href="#1-1-2-setup-uaa-environment" class="toc-link node-name--H3 ">1.1.2 Setup UAA Environment</a></li><li class="toc-list-item"><a href="#1-1-3-publish-and-push-sample" class="toc-link node-name--H3 ">1.1.3 Publish and Push Sample</a></li><li class="toc-list-item"><a href="#1-1-4-logging-in" class="toc-link node-name--H3 ">1.1.4 Logging in</a></li><li class="toc-list-item"><a href="#1-1-5-testing-permissions" class="toc-link node-name--H3 ">1.1.5 Testing Permissions</a></li><li class="toc-list-item"><a href="#1-1-6-understand-sample" class="toc-link node-name--H3 ">1.1.6 Understand Sample</a></li></ul></li><li class="toc-list-item"><a href="#1-2-usage" class="toc-link node-name--H2 ">1.2 Usage</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#1-2-1-add-nuget-reference" class="toc-link node-name--H3 ">1.2.1 Add NuGet Reference</a></li><li class="toc-list-item"><a href="#1-2-2-configure-settings" class="toc-link node-name--H3 ">1.2.2 Configure Settings</a></li><li class="toc-list-item"><a href="#1-2-3-cloud-foundry" class="toc-link node-name--H3 ">1.2.3 Cloud Foundry</a></li><li class="toc-list-item"><a href="#1-2-4-add-cloud-foundry-oauth" class="toc-link node-name--H3 ">1.2.4 Add Cloud Foundry OAuth</a></li><li class="toc-list-item"><a href="#1-2-5-securing-endpoints" class="toc-link node-name--H3 ">1.2.5 Securing Endpoints</a></li></ul></li></ul></li><li class="toc-list-item"><a href="#2-0-single-sign-on-with-openid-connect" class="toc-link node-name--H1 ">2.0 Single Sign-on with OpenID Connect</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#2-1-quick-start" class="toc-link node-name--H2 ">2.1 Quick Start</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#2-1-1-locate-sample" class="toc-link node-name--H3 ">2.1.1 Locate Sample</a></li><li class="toc-list-item"><a href="#2-1-2-setup-uaa-environment" class="toc-link node-name--H3 ">2.1.2 Setup UAA Environment</a></li><li class="toc-list-item"><a href="#2-1-3-publish-and-push-sample" class="toc-link node-name--H3 ">2.1.3 Publish and Push Sample</a></li><li class="toc-list-item"><a href="#2-1-4-logging-in" class="toc-link node-name--H3 ">2.1.4 Logging in</a></li><li class="toc-list-item"><a href="#2-1-5-testing-permissions" class="toc-link node-name--H3 ">2.1.5 Testing Permissions</a></li><li class="toc-list-item"><a href="#2-1-6-understand-sample" class="toc-link node-name--H3 ">2.1.6 Understand Sample</a></li></ul></li><li class="toc-list-item"><a href="#2-2-usage" class="toc-link node-name--H2 ">2.2 Usage</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#2-2-1-usage-in-asp-net-core" class="toc-link node-name--H3 ">2.2.1 Usage in ASP.NET Core</a></li><li class="toc-list-item"><a href="#2-2-2-usage-in-asp-net-4-x" class="toc-link node-name--H3 ">2.2.2 Usage in ASP.NET 4.x</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#2-2-2-1-add-nuget-reference" class="toc-link node-name--H4 ">2.2.2.1 Add NuGet Reference</a></li><li class="toc-list-item"><a href="#2-2-2-2-configure-settings" class="toc-link node-name--H4 ">2.2.2.2 Configure Settings</a></li><li class="toc-list-item"><a href="#2-2-2-3-cloud-foundry" class="toc-link node-name--H4 ">2.2.2.3 Cloud Foundry</a></li><li class="toc-list-item"><a href="#2-2-2-4-configure-owin-startup" class="toc-link node-name--H4 ">2.2.2.4 Configure OWIN Startup</a></li><li class="toc-list-item"><a href="#2-2-2-5-redirecting-to-oauth-server" class="toc-link node-name--H4 ">2.2.2.5 Redirecting to OAuth Server</a></li><li class="toc-list-item"><a href="#2-2-2-6-securing-endpoints" class="toc-link node-name--H4 ">2.2.2.6 Securing Endpoints</a></li></ul></li></ul></li></ul></li><li class="toc-list-item"><a href="#3-0-resource-protection-using-jwt" class="toc-link node-name--H1 ">3.0 Resource Protection using JWT</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#3-1-quick-start" class="toc-link node-name--H2 ">3.1 Quick Start</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#3-1-1-locate-sample" class="toc-link node-name--H3 ">3.1.1 Locate Sample</a></li><li class="toc-list-item"><a href="#3-1-2-do-oauth-sso-quick-start" class="toc-link node-name--H3 ">3.1.2 Do OAuth SSO Quick Start</a></li><li class="toc-list-item"><a href="#3-1-3-publish-and-push-sample" class="toc-link node-name--H3 ">3.1.3  Publish and Push Sample</a></li><li class="toc-list-item"><a href="#3-1-4-observe-logs" class="toc-link node-name--H3 ">3.1.4 Observe Logs</a></li><li class="toc-list-item"><a href="#3-1-5-access-the-application" class="toc-link node-name--H3 ">3.1.5 Access the Application</a></li><li class="toc-list-item"><a href="#3-1-6-understand-sample" class="toc-link node-name--H3 ">3.1.6 Understand Sample</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#3-1-6-1-asp-net-core" class="toc-link node-name--H4 ">3.1.6.1 ASP.NET Core</a></li><li class="toc-list-item"><a href="#3-1-6-2-asp-net-webapi" class="toc-link node-name--H4 ">3.1.6.2 ASP.NET WebAPI</a></li><li class="toc-list-item"><a href="#3-1-6-3-wcf-service" class="toc-link node-name--H4 ">3.1.6.3 WCF Service</a></li></ul></li></ul></li><li class="toc-list-item"><a href="#3-2-usage-in-asp-net-core" class="toc-link node-name--H2 ">3.2 Usage in ASP.NET Core</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#3-2-1-add-nuget-reference" class="toc-link node-name--H3 ">3.2.1 Add NuGet Reference</a></li><li class="toc-list-item"><a href="#3-2-2-configure-settings" class="toc-link node-name--H3 ">3.2.2 Configure Settings</a></li><li class="toc-list-item"><a href="#3-2-3-cloud-foundry" class="toc-link node-name--H3 ">3.2.3 Cloud Foundry</a></li><li class="toc-list-item"><a href="#3-2-4-add-cloud-foundry-jwtauthentication" class="toc-link node-name--H3 ">3.2.4 Add Cloud Foundry JwtAuthentication</a></li><li class="toc-list-item"><a href="#3-2-5-securing-endpoints" class="toc-link node-name--H3 ">3.2.5 Securing Endpoints</a></li></ul></li><li class="toc-list-item"><a href="#3-3-usage-in-asp-net-webapi" class="toc-link node-name--H2 ">3.3 Usage in ASP.NET WebAPI</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#3-3-1-add-nuget-reference" class="toc-link node-name--H3 ">3.3.1 Add NuGet Reference</a></li><li class="toc-list-item"><a href="#3-3-2-configure-settings" class="toc-link node-name--H3 ">3.3.2 Configure Settings</a></li><li class="toc-list-item"><a href="#3-3-3-cloud-foundry" class="toc-link node-name--H3 ">3.3.3 Cloud Foundry</a></li><li class="toc-list-item"><a href="#3-3-4-add-cloud-foundry-jwtauthentication" class="toc-link node-name--H3 ">3.3.4 Add Cloud Foundry JwtAuthentication</a></li><li class="toc-list-item"><a href="#3-3-5-securing-endpoints" class="toc-link node-name--H3 ">3.3.5 Securing Endpoints</a></li></ul></li><li class="toc-list-item"><a href="#3-4-usage-in-asp-net-wcf" class="toc-link node-name--H2 ">3.4 Usage in ASP.NET WCF</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#3-4-1-add-nuget-reference" class="toc-link node-name--H3 ">3.4.1 Add NuGet Reference</a></li><li class="toc-list-item"><a href="#3-4-2-configure-settings" class="toc-link node-name--H3 ">3.4.2 Configure Settings</a></li><li class="toc-list-item"><a href="#3-4-3-cloud-foundry" class="toc-link node-name--H3 ">3.4.3 Cloud Foundry</a></li><li class="toc-list-item"><a href="#3-4-4-set-serviceauthorizationmanager" class="toc-link node-name--H3 ">3.4.4 Set ServiceAuthorizationManager</a></li><li class="toc-list-item"><a href="#3-4-5-securing-endpoints" class="toc-link node-name--H3 ">3.4.5 Securing Endpoints</a></li><li class="toc-list-item"><a href="#3-4-6-updating-client-to-send-jwt" class="toc-link node-name--H3 ">3.4.6 Updating Client to Send JWT</a></li></ul></li></ul></li><li class="toc-list-item"><a href="#4-0-redis-key-storage-provider" class="toc-link node-name--H1 ">4.0 Redis Key Storage Provider</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#4-1-quick-start" class="toc-link node-name--H2 ">4.1 Quick Start</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#4-1-1-locate-sample" class="toc-link node-name--H3 ">4.1.1 Locate Sample</a></li><li class="toc-list-item"><a href="#4-1-2-create-service" class="toc-link node-name--H3 ">4.1.2 Create Service</a></li><li class="toc-list-item"><a href="#4-1-3-publish-and-push-sample" class="toc-link node-name--H3 ">4.1.3 Publish and Push Sample</a></li><li class="toc-list-item"><a href="#4-1-4-observe-logs" class="toc-link node-name--H3 ">4.1.4 Observe Logs</a></li><li class="toc-list-item"><a href="#4-1-5-access-the-application" class="toc-link node-name--H3 ">4.1.5 Access the Application</a></li><li class="toc-list-item"><a href="#4-1-6-understand-sample" class="toc-link node-name--H3 ">4.1.6 Understand Sample</a></li></ul></li><li class="toc-list-item"><a href="#4-2-usage" class="toc-link node-name--H2 ">4.2 Usage</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#4-2-1-add-nuget-reference" class="toc-link node-name--H3 ">4.2.1 Add NuGet Reference</a></li><li class="toc-list-item"><a href="#4-2-2-cloud-foundry" class="toc-link node-name--H3 ">4.2.2 Cloud Foundry</a></li><li class="toc-list-item"><a href="#4-2-3-add-redis-iconnectionmultiplexer" class="toc-link node-name--H3 ">4.2.3 Add Redis IConnectionMultiplexer</a></li><li class="toc-list-item"><a href="#4-2-4-add-persistkeystoredis" class="toc-link node-name--H3 ">4.2.4 Add PersistKeysToRedis</a></li><li class="toc-list-item"><a href="#4-2-5-use-redis-key-store" class="toc-link node-name--H3 ">4.2.5 Use Redis Key Store</a></li></ul></li></ul></li><li class="toc-list-item"><a href="#5-0-credhub-api-client" class="toc-link node-name--H1 ">5.0 CredHub API Client</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-1-quick-start" class="toc-link node-name--H2 ">5.1 Quick Start</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-1-1-locate-sample" class="toc-link node-name--H3 ">5.1.1 Locate Sample</a></li><li class="toc-list-item"><a href="#5-1-2-publish-and-push-sample" class="toc-link node-name--H3 ">5.1.2 Publish and Push Sample</a></li><li class="toc-list-item"><a href="#5-1-3-observe-logs" class="toc-link node-name--H3 ">5.1.3 Observe Logs</a></li><li class="toc-list-item"><a href="#5-1-4-view-results" class="toc-link node-name--H3 ">5.1.4 View Results</a></li><li class="toc-list-item"><a href="#5-1-5-understand-the-sample" class="toc-link node-name--H3 ">5.1.5 Understand the Sample</a></li></ul></li><li class="toc-list-item"><a href="#5-2-usage" class="toc-link node-name--H2 ">5.2 Usage</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-2-1-add-nuget-reference" class="toc-link node-name--H3 ">5.2.1 Add NuGet Reference</a></li><li class="toc-list-item"><a href="#5-2-2-configure-settings" class="toc-link node-name--H3 ">5.2.2 Configure Settings</a></li><li class="toc-list-item"><a href="#5-2-3-on-cloud-foundry" class="toc-link node-name--H3 ">5.2.3 On Cloud Foundry</a></li><li class="toc-list-item"><a href="#5-2-4-getting-a-client" class="toc-link node-name--H3 ">5.2.4 Getting a Client</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-2-4-1-create-and-inject-client" class="toc-link node-name--H4 ">5.2.4.1 Create and Inject Client</a></li><li class="toc-list-item"><a href="#5-2-4-2-create-uaa-client" class="toc-link node-name--H4 ">5.2.4.2 Create UAA Client</a></li><li class="toc-list-item"><a href="#5-2-4-3-interpolation-only" class="toc-link node-name--H4 ">5.2.4.3 Interpolation-Only</a></li></ul></li><li class="toc-list-item"><a href="#5-2-4-credential-types" class="toc-link node-name--H3 ">5.2.4 Credential Types</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-2-4-1-valuecredential" class="toc-link node-name--H4 ">5.2.4.1 ValueCredential</a></li><li class="toc-list-item"><a href="#5-2-4-2-passwordcredential" class="toc-link node-name--H4 ">5.2.4.2 PasswordCredential</a></li><li class="toc-list-item"><a href="#5-2-4-3-usercredential" class="toc-link node-name--H4 ">5.2.4.3 UserCredential</a></li><li class="toc-list-item"><a href="#5-2-4-4-jsoncredential" class="toc-link node-name--H4 ">5.2.4.4 JsonCredential</a></li><li class="toc-list-item"><a href="#5-2-4-5-certificatecredential" class="toc-link node-name--H4 ">5.2.4.5 CertificateCredential</a></li><li class="toc-list-item"><a href="#5-2-4-6-rsacredential" class="toc-link node-name--H4 ">5.2.4.6 RsaCredential</a></li><li class="toc-list-item"><a href="#5-2-4-7-sshcredential" class="toc-link node-name--H4 ">5.2.4.7 SshCredential</a></li></ul></li><li class="toc-list-item"><a href="#5-2-5-credhub-read-operations" class="toc-link node-name--H3 ">5.2.5 CredHub Read Operations</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-2-5-1-get-by-id" class="toc-link node-name--H4 ">5.2.5.1 Get by ID</a></li><li class="toc-list-item"><a href="#5-2-5-2-get-by-name" class="toc-link node-name--H4 ">5.2.5.2 Get by Name</a></li><li class="toc-list-item"><a href="#5-2-5-3-get-by-name-with-history" class="toc-link node-name--H4 ">5.2.5.3 Get by Name with History</a></li><li class="toc-list-item"><a href="#5-2-5-4-find-by-name" class="toc-link node-name--H4 ">5.2.5.4 Find by Name</a></li><li class="toc-list-item"><a href="#5-2-5-5-find-by-path" class="toc-link node-name--H4 ">5.2.5.5 Find by Path</a></li><li class="toc-list-item"><a href="#5-2-5-6-find-all-paths" class="toc-link node-name--H4 ">5.2.5.6 Find All Paths</a></li><li class="toc-list-item"><a href="#5-2-5-7-interpolate" class="toc-link node-name--H4 ">5.2.5.7 Interpolate</a></li></ul></li><li class="toc-list-item"><a href="#5-2-6-credhub-change-operations" class="toc-link node-name--H3 ">5.2.6 CredHub Change Operations</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-2-6-1-write" class="toc-link node-name--H4 ">5.2.6.1 Write</a></li><li class="toc-list-item"><a href="#5-2-7-2-generate" class="toc-link node-name--H4 ">5.2.7.2 Generate</a></li><li class="toc-list-item"><a href="#5-2-6-3-regenerate" class="toc-link node-name--H4 ">5.2.6.3 Regenerate</a></li><li class="toc-list-item"><a href="#5-2-6-4-bulk-regenerate" class="toc-link node-name--H4 ">5.2.6.4 Bulk Regenerate</a></li><li class="toc-list-item"><a href="#5-2-6-5-delete-by-name" class="toc-link node-name--H4 ">5.2.6.5 Delete by Name</a></li></ul></li><li class="toc-list-item"><a href="#5-2-7-permission-operations" class="toc-link node-name--H3 ">5.2.7 Permission Operations</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#5-2-7-1-get-permissions" class="toc-link node-name--H4 ">5.2.7.1 Get Permissions</a></li><li class="toc-list-item"><a href="#5-2-7-2-add-permissions" class="toc-link node-name--H4 ">5.2.7.2 Add Permissions</a></li><li class="toc-list-item"><a href="#5-2-7-3-delete-permissions" class="toc-link node-name--H4 ">5.2.7.3 Delete Permissions</a></li></ul></li></ul></li></ul></li><li class="toc-list-item"><a href="#common-steps" class="toc-link node-name--H1 ">Common Steps</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#set-up-uaa" class="toc-link node-name--H2 ">Set up UAA</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#get-uaa-cli" class="toc-link node-name--H3 ">Get UAA CLI</a></li><li class="toc-list-item"><a href="#get-admin-client-token" class="toc-link node-name--H3 ">Get Admin Client Token</a></li><li class="toc-list-item"><a href="#add-user-and-group" class="toc-link node-name--H3 ">Add User and Group</a></li><li class="toc-list-item"><a href="#add-application-client" class="toc-link node-name--H3 ">Add Application Client</a></li><li class="toc-list-item"><a href="#create-service" class="toc-link node-name--H3 ">Create Service</a></li></ul></li><li class="toc-list-item"><a href="#publish-sample" class="toc-link node-name--H2 ">Publish Sample</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="#asp-net-core" class="toc-link node-name--H3 ">ASP.NET Core</a></li><li class="toc-list-item"><a href="#asp-net-4-x" class="toc-link node-name--H3 ">ASP.NET 4.x</a></li></ul></li><li class="toc-list-item"><a href="#push-sample" class="toc-link node-name--H2 ">Push Sample</a></li><li class="toc-list-item"><a href="#observe-logs" class="toc-link node-name--H2 ">Observe Logs</a></li><li class="toc-list-item"><a href="#reading-configuration-values" class="toc-link node-name--H2 ">Reading Configuration Values</a></li></ul></li></ul></div>

					</div>
				</div>
				<div class="col-12 sm-col-9 js-toc-content">

					<h1 id="1-0-single-sign-on-with-oauth2">1.0 Single Sign-on with OAuth2</h1>

					<p>Single Sign-on with OAuth 2.0 enables you to leverage existing credentials configured in a <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity">Pivotal Single Sign-on service</a> for authentication and authorization in ASP.NET Core applications. Single signon functionality for ASP.NET 4.x applications is available with the <a href="#2-0.single-sign-on-with-openid-connect">OpenID Connect provider</a>.</p>

					<p>In addition to the Quick Start, you can use other Steeltoe sample applications to help you understand how to use this provider, including:</p>

					<ul>
						<li><a target="_blank" href="https://github.com/SteeltoeOSS/Samples/tree/master/FreddysBBQ">FreddysBBQ</a>: A polyglot microservices-based sample application showing interoperability between Java and .NET on Cloud Foundry, secured with OAuth2 Security Services, and using Spring Cloud Services.</li>
					</ul>

					<p>The source code for this provider can be found <a target="_blank" href="https://github.com/SteeltoeOSS/Security">here</a>.</p>

					
					<p>This package is built on the OAuth 2 authentication flow and the services provided by ASP.NET Core Security. You should take some time to understand both before proceeding to use this provider.</p>

					<p>Many resources are available for understanding OAuth 2. For example, see <a target="_blank"  href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">Introduction to OAuth 2</a> or <a target="_blank"  href="https://www.bubblecode.net/en/2016/01/22/understanding-oauth2/">Understanding OAuth 2</a>.</p>

					<p>To get a good understanding of ASP.NET Core Security, review the <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/core/security">documentation</a> provided by Microsoft. If you are upgrading an application from ASP.NET Core 1.x, you may also want to review <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/core/migration/1x-to-2x/identity-2x">Migrating Auth and Identity to ASP.NET Core 2.0</a>.</p>

					<p>Additionally, you should know how the <a target="_blank"  target="_blank" href="https://docs.asp.net/en/latest/fundamentals/configuration.html">.NET Configuration service</a> and the <code>ConfigurationBuilder</code> work and how to add providers to the builder.</p>

					<p>You should also know how the ASP.NET Core <a target="_blank"  target="_blank" href="https://docs.asp.net/en/latest/fundamentals/startup.html">Startup</a> class is used in configuring the application services and how the middleware used in the application. Pay particular attention to the usage of the <code>Configure()</code> and <code>ConfigureService())</code> methods.</p>

					<p>With regard to Cloud Foundry, you should know how Cloud Foundry OAuth2 security services (for example, <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity/">Pivotal Single Signon</a>) work.</p>

					<p>In order to use the security provider:</p>

					<ol>
						<li>Create an instance of a Cloud Foundry OAuth2 service and bind it to your application.</li>
						<li>(Optional) Configure any additional settings the security provider needs.</li>
						<li>Add the Cloud Foundry configuration provider to the <code>ConfigurationBuilder</code>.</li>
						<li>Add and use the security provider in the application.</li>
						<li>Secure your endpoints.</li>
					</ol>

					<h3 id="1-2-1-add-nuget-reference">1.2.1 Add NuGet Reference</h3>

					<p>To use the provider, add a reference to the Steeltoe Cloud Foundry Security NuGet.</p>

					<p>The provider can be found in the <code>Steeltoe.Security.Authentication.CloudFoundryCore</code> package.</p>

					<p>You can add the provider to your project by using the following <code>PackageReference</code>:</p>

<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
...
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Steeltoe.Security.Authentication.CloudFoundryCore"</span> <span class="hljs-attr">Version</span>= <span class="hljs-string">"2.3.0"</span>/&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
</code></pre>

					<h3 id="1-2-2-configure-settings">1.2.2 Configure Settings</h3>

					<p>Configuring settings for the provider beyond what is provided in a service binding is not typically required, but when Cloud Foundry is using self-signed certificates, you might need to disable certificate validation, as shown in the following example:</p>

<pre><code class="json hljs">{
    <span class="hljs-attr">"security"</span>: {
        <span class="hljs-attr">"oauth2"</span>: {
            <span class="hljs-attr">"client"</span>: {
                <span class="hljs-attr">"validateCertificates"</span>: <span class="hljs-literal">false</span>
            }
        }
    }
}
</code></pre>

					<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<p>The Steeltoe OAuth2 security provider options are based on <a target="_blank" href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.oauth.oauthoptions"><code>Microsoft.AspNetCore.Authentication.OAuth.OAuthOptions</code></a>, with these additional properties:</p>

					<table>
						<thead>
							<tr>
								<th>Name</th>
								<th>Description</th>
								<th>Default</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>additionalScopes</td>
								<td>Scopes to request for tokens in addition to <code>openid</code></td>
								<td><code>string.Empty</code></td>
							</tr>
							<tr>
								<td>validateCertificates</td>
								<td>Validate Auth server certificate</td>
								<td><code>true</code></td>
							</tr>
						</tbody>
					</table>

					<p><strong>Note</strong>: <strong>Each setting above must be prefixed with <code>security:oauth2:client</code></strong>.</p>

					<h3 id="1-2-3-cloud-foundry">1.2.3 Cloud Foundry</h3>

					<p>As mentioned earlier, there are two OAuth-compatible services available on Cloud Foundry. We recommend you read the offical documentation (<a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> and <a target="_blank" href="https://docs.pivotal.io/p-identity/1-5/getting-started.html">Pivotal SSO</a>) or follow the instructions included in the samples for <a target="_blank" href="https://github.com/SteeltoeOSS/Samples/blob/master/Security/src/AspDotNetCore/CloudFoundrySingleSignon/README.md">UAA Server</a> and <a target="_blank" href="https://github.com/SteeltoeOSS/Samples/blob/master/Security/src/AspDotNetCore/CloudFoundrySingleSignon/README-SSO.md">Pivotal SSO</a> to quickly learn how to create and bind OAuth2 services.</p>

					<p>Regardless of which provider you choose, once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h3 id="1-2-4-add-cloud-foundry-oauth">1.2.4 Add Cloud Foundry OAuth</h3>

					<p>
						As with other ASP.NET Core middleware, in order to configure the Cloud Foundry OAuth provider in your application,
						first add and configure it in the <code>ConfigureServices()</code> method of the <code>Startup</code> class, then use it in the <code>Configure()</code>
						method of the <code>Startup</code> class. The Cloud Foundry OAuth provider is built on top of ASP.NET Core Authentication services
						and is configured with an extension method on the <code>AuthenticationBuilder</code>, as seen in the following example:
					</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.Security.Authentication.CloudFoundry;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span> {
    ...
    <span class="hljs-keyword">public</span> IConfiguration Configuration { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Startup</span>(<span class="hljs-params">IConfiguration configuration</span>)
    </span>{
        Configuration = configuration;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)
    </span>{
        ...
        services.AddAuthentication(options =&gt;
            {
                options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
                options.DefaultChallengeScheme = CloudFoundryDefaults.AuthenticationScheme;
            })
            .AddCookie((options) =&gt;
            {
                <span class="hljs-comment">// set values like login url, access denied path, etc here</span>
                options.AccessDeniedPath = <span class="hljs-keyword">new</span> PathString(<span class="hljs-string">"/Home/AccessDenied"</span>);
            })
            .AddCloudFoundryOAuth(Configuration); <span class="hljs-comment">// Add Cloud Foundry authentication service</span>
        ...
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">IApplicationBuilder app, ...</span>)
    </span>{
        ...
        <span class="hljs-comment">// Use the protocol from the original request when generating redirect uris</span>
        <span class="hljs-comment">// (eg: when TLS termination is handled by an appliance in front of the app)</span>
        app.UseForwardedHeaders(<span class="hljs-keyword">new</span> ForwardedHeadersOptions
        {
            ForwardedHeaders = ForwardedHeaders.XForwardedProto
        });

        <span class="hljs-comment">// Add authentication middleware to pipeline</span>
        app.UseAuthentication();
    }
    ...
</code></pre>

					<p>The <code>AddCloudFoundryOAuth(Configuration)</code> method call configures and adds the Cloud Foundry OAuth authentication service to the service container. Once in place, it can be used by the authentication middleware during request processing.</p>

					<blockquote>
						<p>NOTE: When running behind a reverse-proxy (like Gorouter or HAProxy) that handles TLS termination for your app, use <code>app.UseForwardedHeaders</code> to generate the correct redirect URI so that the user is not sent back over HTTP instead of HTTPS after authenticating.</p>
					</blockquote>

					<h3 id="1-2-5-securing-endpoints">1.2.5 Securing Endpoints</h3>

					<p>Once the <code>Startup</code> class has been updated, you can secure endpoints with the standard ASP.NET Core <code>Authorize</code> attribute, as shown in the following example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Authentication;
...
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HomeController</span> : <span class="hljs-title">Controller</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Index</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">return</span> View();
    }

    [Authorize]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">About</span>(<span class="hljs-params"></span>)
    </span>{
        ViewData[<span class="hljs-string">"Message"</span>] = <span class="hljs-string">"Your About page."</span>;
        <span class="hljs-keyword">return</span> View();
    }

    [Authorize(Policy = <span class="hljs-string">"testgroup1"</span>)]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Contact</span>(<span class="hljs-params"></span>)
    </span>{
        ViewData[<span class="hljs-string">"Message"</span>] = <span class="hljs-string">"Your contact page."</span>;
        <span class="hljs-keyword">return</span> View();
    }
    ...
}
</code></pre>

					<p>The preceding example code establishes the following security rules:</p>

					<ul>
						<li>If a user attempts to access the <code>About</code> action and the user is not authenticated, then the user is redirected to the OAuth2 server (such as a UAA Server) to login.</li>
						<li>If an authenticated user attempts to access the <code>Contact</code> action but does not meet the restrictions established by the policy <code>testgroup1</code>, the user is denied access.</li>
					</ul>

					<blockquote>
						<p>TIP: See the Microsoft documentation on <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/core/security/authorization/introduction">ASP.NET Core Authorization</a>.</p>
					</blockquote>

					<h1 id="2-0-single-sign-on-with-openid-connect">2.0 Single Sign-on with OpenID Connect</h1>

					<p>Single Sign-on with OpenID Connect enables you to leverage existing credentials configured in a <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity">Pivotal Single Sign-on service</a> for authentication and authorization in ASP.NET 4.x (via OWIN middleware) and ASP.NET Core applications.</p>

					<p>The source code for this provider can be found <a target="_blank" href="https://github.com/SteeltoeOSS/Security">here</a>.</p>

					<h3 id="2-2-1-usage-in-asp-net-core">2.2.1 Usage in ASP.NET Core</h3>

					<p>Steeltoe builds on top of <code>Microsoft.AspNetCore.Authentication.OpenIdConnect</code>. You may benefit from reading more about using <a target="_blank"  href="https://andrewlock.net/an-introduction-to-openid-connect-in-asp-net-core/">OpenID Connect in ASP.NET Core</a>.</p>

					<p>Usage of Steeltoe’s OpenID Connect provider is effectively identical to that of the <a href="#1-2-usage">OAuth2 provider</a>, although the behind-the-scenes story is a little different. The OpenID Connect provider uses Microsoft’s OpenId Connect implementation, and settings are based on <code>Microsoft.AspNetCore.Authentication.OpenIdConnect.OpenIdConnectOptions</code>, with these additional properties:</p>

					<table>
						<thead>
							<tr>
								<th>Name</th>
								<th>Description</th>
								<th>Default</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>additionalScopes</td>
								<td>Scopes to request for tokens in addition to <code>openid</code></td>
								<td><code>string.Empty</code></td>
							</tr>
							<tr>
								<td>validateCertificates</td>
								<td>Validate Auth server certificate</td>
								<td><code>true</code></td>
							</tr>
						</tbody>
					</table>

					<p><strong>Note</strong>: <strong>Each setting above must be prefixed with <code>security:oauth2:client</code></strong>.</p>

					<p>Aside from the different base class for options, the only usage change is to call <code>.AddCloudFoundryOpenId</code> instead of <code>.AddCloudFoundryOAuth</code>.</p>

					<h3 id="2-2-2-usage-in-asp-net-4-x">2.2.2 Usage in ASP.NET 4.x</h3>

					<p>This package is built on OpenID Connect and OWIN Middleware. You should take some time to understand both before proceeding to use this provider.</p>

					<p>Resources are available elsewhere for understanding OpenID Connect. For example, see <a target="_blank"  href="https://blog.runscope.com/posts/understanding-oauth-2-and-openid-connect">Understanding OAuth 2.0 and OpenID Connect</a>.</p>

					<p>To learn more about OWIN, start with the <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/an-overview-of-project-katana">Overview of Project Katana</a>.</p>

					<p>Additionally, you should know how the .NET <a target="_blank" href="https://docs.asp.net/en/latest/fundamentals/configuration.html">Configuration service</a> and the <code>ConfigurationBuilder</code> work and how to add providers to the builder.</p>

					<p>With regard to Cloud Foundry, you should know how Cloud Foundry OAuth security services (for example, <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity/">Pivotal Single Signon</a>) work.</p>

					<p>In order to use the Security provider:</p>

					<ol>
						<li>Create an instance of a Cloud Foundry OAuth service and bind it to your application.</li>
						<li>(Optional) Configure any additional settings the Security provider needs.</li>
						<li>Add the Cloud Foundry configuration provider to the <code>ConfigurationBuilder</code>.</li>
						<li>Add the security provider to the OWIN pipeline in the application.</li>
						<li>Secure your endpoints.</li>
					</ol>

					<h4 id="2-2-2-1-add-nuget-reference">2.2.2.1 Add NuGet Reference</h4>

					<p>To use the provider, use the NuGet package manager to add a reference to the <code>Steeltoe.Security.Authentication.CloudFoundryOwin</code> package.</p>

					<h4 id="2-2-2-2-configure-settings">2.2.2.2 Configure Settings</h4>

					<p>Configuring settings for the provider beyond what is provided in a service binding is not typically required, but when Cloud Foundry is using self-signed certificates, you might need to disable certificate validation, as shown in the following example:</p>

<pre><code class="json hljs">{
    <span class="hljs-attr">"security"</span>: {
        <span class="hljs-attr">"oauth2"</span>: {
            <span class="hljs-attr">"client"</span>: {
                <span class="hljs-attr">"validateCertificates"</span>: <span class="hljs-literal">false</span>
            }
        }
    }
}
</code></pre>

					<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<p>This full list of settings can also be configured, though <code>AuthDomain</code>, <code>ClientId</code> and <code>ClientSecret</code> will be overridden by service bindings (if present).</p>

					<table>
						<thead>
							<tr>
								<th>Name</th>
								<th>Description</th>
								<th>Default</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>additionalScopes</td>
								<td>Scopes to request for tokens in addition to <code>openid</code></td>
								<td><code>string.Empty</code></td>
							</tr>
							<tr>
								<td>authDomain</td>
								<td>Location of the OAuth2 server</td>
								<td><code>https://Default_OAuthServiceUrl</code></td>
							</tr>
							<tr>
								<td>authenticationType</td>
								<td>Corresponds to the IIdentity AuthenticationType</td>
								<td><code>CloudFoundry</code></td>
							</tr>
							<tr>
								<td>callbackPath</td>
								<td>Path the user is redirected back to after authentication</td>
								<td><code>/signin-cloudfoundry</code></td>
							</tr>
							<tr>
								<td>clientId</td>
								<td>App credentials with auth server</td>
								<td><code>Default_ClientId</code></td>
							</tr>
							<tr>
								<td>clientSecret</td>
								<td>App credentials with auth server</td>
								<td><code>Default_ClientSecret</code></td>
							</tr>
							<tr>
								<td>validateCertificates</td>
								<td>Validate OAuth2 server certificate</td>
								<td><code>true</code></td>
							</tr>
						</tbody>
					</table>

					<p><strong>Note</strong>: <strong>Each setting above must be prefixed with <code>security:oauth2:client</code></strong>.</p>

					<blockquote>
						<p>NOTE: Prior to Steeltoe 2.2, the default value for CallbackPath was <code>/signin-oidc</code></p>
					</blockquote>

					<h4 id="2-2-2-3-cloud-foundry">2.2.2.3 Cloud Foundry</h4>

					<p>As mentioned earlier, there are two ways to use OAuth2 services on Cloud Foundry. We recommend you read the offical documentation (<a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> and <a target="_blank" href="https://docs.pivotal.io/p-identity/1-5/getting-started.html">Pivotal SSO</a>) or follow the instructions included in the samples for <a target="_blank" href="https://github.com/SteeltoeOSS/Samples/blob/master/Security/src/AspDotNet4/CloudFoundrySingleSignon/README.md">UAA Server</a> and <a target="_blank" href="https://github.com/SteeltoeOSS/Samples/blob/master/Security/src/AspDotNet4/CloudFoundrySingleSignon/README-SSO.md">Pivotal SSO</a> to quickly learn how to create and bind OAuth2 services.</p>

					<p>Regardless of which provider you choose, once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h4 id="2-2-2-4-configure-owin-startup">2.2.2.4 Configure OWIN Startup</h4>

					<p>In order to configure the Cloud Foundry OWIN OAuth provider in your application, you will need an <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/owin-startup-class-detection">OWIN Startup class</a> if you do not already have one.</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.Security.Authentication.CloudFoundry.Owin;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.IdentityModel.Claims;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Web.Helpers;

[assembly: OwinStartup(<span class="hljs-keyword">typeof</span>(CloudFoundrySingleSignon.Startup))]

<span class="hljs-keyword">namespace</span> <span class="hljs-title">CloudFoundrySingleSignon</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configuration</span>(<span class="hljs-params">IAppBuilder app</span>)
        </span>{
            app.SetDefaultSignInAsAuthenticationType(<span class="hljs-string">"ExternalCookie"</span>);
            app.UseCookieAuthentication(<span class="hljs-keyword">new</span> CookieAuthenticationOptions
            {
                AuthenticationType = <span class="hljs-string">"ExternalCookie"</span>,
                AuthenticationMode = AuthenticationMode.Active,
                CookieName = <span class="hljs-string">".AspNet.ExternalCookie"</span>,
                LoginPath = <span class="hljs-keyword">new</span> PathString(<span class="hljs-string">"/Account/AuthorizeSSO"</span>),
                ExpireTimeSpan = TimeSpan.FromMinutes(<span class="hljs-number">5</span>)
            });

            app.UseCloudFoundryOpenIdConnect(ApplicationConfig.Configuration);

            AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;
        }
    }
}
</code></pre>

					<p>The <code>app.UseCloudFoundryOpenIdConnect</code> method call adds an authentication middleware that has been configured to work with UAA or Pivotal SSO to the OWIN Request pipeline.</p>

					<blockquote>
						<p>TIP: This code is commonly refactored into a separate class (for example <code>Startup.Auth.cs</code>), particularly when there is additional configuration on the OWIN pipeline.</p>
					</blockquote>

					<h4 id="2-2-2-5-redirecting-to-oauth-server">2.2.2.5 Redirecting to OAuth Server</h4>

					<p>To redirect the user to the OAuth server for authentication, invoke <code>IAuthenticationManager.Challenge</code>, specifying a redirect uri (for the user to land on after authentication) and the string value configured as the authentication type.</p>

					<p>In Steeltoe 2.2 and up, the default value for AuthenticationType is <code>CloudFoundryDefaults.DisplayName</code> or “CloudFoundry”. Prior to Steeltoe 2.2, this value was <code>PivotalSSO</code> and was not configureable. The now-deprecated extension <code>.UseOpenIDConnect()</code> still uses that as the default, but can be overridden in <code>OpenIDConnectOptions</code>.</p>

<pre><code class="csharp hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AuthorizeSSO</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> returnUrl</span>)
</span>{
    <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">new</span> AuthenticationProperties { RedirectUri = returnUrl ?? Url.Action(<span class="hljs-string">"Secure"</span>, <span class="hljs-string">"Home"</span>) };
    HttpContext.GetOwinContext().Authentication.Challenge(properties, CloudFoundryDefaults.DisplayName);
}
</code></pre>

					<blockquote>
						<p>NOTE: The second parameter passed to <code>Authentication.Challenge</code> <em>must</em> match the authentication type used to configure the provider; this is the piece that hands the flow over to Steeltoe.</p>
					</blockquote>

					<p>If you wish to allow your controller action to return <code>ActionResult</code> instead of void, refactor the call to <code>Challenge</code> into a class that inherits <code>HttpUnauthorizedResult</code> such as this</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ChallengeResult</span> : <span class="hljs-title">HttpUnauthorizedResult</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ChallengeResult</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> authType, <span class="hljs-keyword">string</span> redirectUri</span>)
    </span>{
        AuthenticationType = authType;
        RedirectUri = redirectUri;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> AuthenticationType { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> RedirectUri { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ExecuteResult</span>(<span class="hljs-params">ControllerContext context</span>)
    </span>{
        <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">new</span> AuthenticationProperties { RedirectUri = RedirectUri };
        context.HttpContext.GetOwinContext().Authentication.Challenge(properties, AuthenticationType);
    }
}
</code></pre>

					<p>The updated controller code would then look like this:</p>

<pre><code class="csharp hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">AuthorizeSSO</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> returnUrl</span>)
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ChallengeResult(CloudFoundryDefaults.DisplayName, returnUrl ?? Url.Action(<span class="hljs-string">"Secure"</span>, <span class="hljs-string">"Home"</span>));
}
</code></pre>

					<h4 id="2-2-2-6-securing-endpoints">2.2.2.6 Securing Endpoints</h4>

					<p>Once the <code>Startup</code> class is in place and the middleware is configured, you can use the standard ASP.NET <code>Authorize</code> attribute to require authentication, as shown in the following example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> System.Web.Mvc;
...
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HomeController</span> : <span class="hljs-title">Controller</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">Index</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">return</span> View();
    }

    [Authorize]
    <span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">Secure</span>(<span class="hljs-params"></span>)
    </span>{
        ViewData[<span class="hljs-string">"Message"</span>] = <span class="hljs-string">"This page requires authentication"</span>;
        <span class="hljs-keyword">return</span> View();
    }
    ...
}
</code></pre>

					<p>Requiring claims is not built into the framework, so it is not quite as simple as in ASP.NET Core, but is still possible in a variety of ways. The Steeltoe SSO sample demonstrates extending the <a target="_blank" href="https://github.com/IdentityModel/Thinktecture.IdentityModel.45/blob/master/IdentityModel/Thinktecture.IdentityModel/Authorization/MVC/ClaimsAuthorizeAttribute.cs">Thinktecture ClaimsAuthorizeAttribute</a> with a <a target="_blank" href="https://github.com/SteeltoeOSS/Samples/blob/dev/Security/src/AspDotNet4/CloudFoundrySingleSignon/CustomClaimsAuthorizeAttribute.cs">CustomClaimsAuthorizeAttribute</a> to redirect to an “Access Denied” page when a user is authenticated but lacks the required claim. Using either of those attributes is straightforward, as shown in this example:</p>

<pre><code class="csharp hljs"><span class="hljs-comment">// When using this attribute, an authenticated user who does not have the claim will be redirected to the login page</span>
[ClaimsAuthorize(<span class="hljs-string">"testgroup"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">TestGroupV1</span>(<span class="hljs-params"></span>)
</span>{
    ViewBag.Message = <span class="hljs-string">"Congratulations, you have access to 'testgroup'"</span>;
    <span class="hljs-keyword">return</span> View(<span class="hljs-string">"Index"</span>);
}

[CustomClaimsAuthorize(<span class="hljs-string">"testgroup"</span>)]
<span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">TestGroupV2</span>(<span class="hljs-params"></span>)
</span>{
    ViewBag.Message = <span class="hljs-string">"Congratulations, you have access to 'testgroup'"</span>;
    <span class="hljs-keyword">return</span> View(<span class="hljs-string">"Index"</span>);
}
</code></pre>

					<h1 id="3-0-resource-protection-using-jwt">3.0 Resource Protection using JWT</h1>

					<p>This provider lets you control access to REST resources by using JWT tokens issued by Cloud Foundry Security services (such as <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity">Pivotal Single Sign-on</a>) in ASP.NET Core, ASP.NET WebAPI and WCF.</p>

					<p>In addition to the <a href="#2-1-quick-start">Quick Start</a>, other Steeltoe sample applications can help you understand how to use this tool, including:</p>

					<ul>
						<li><a target="_blank" href="https://github.com/SteeltoeOSS/Samples/tree/master/FreddysBBQ">FreddysBBQ</a>: A polyglot microservices-based sample showing interoperability between Java and .NET on Cloud Foundry, secured with OAuth2 Security Services, and using Spring Cloud Services.</li>
					</ul>

					<h2 id="3-2-usage-in-asp-net-core">3.2 Usage in ASP.NET Core</h2>

					<p>This package uses JSON Web Tokens (JWT) and builds on JWT Security services provided by ASP.NET Core Security. You should take some time to understand both before proceeding to use this provider.</p>

					<p>Many resources are available for understanding JWT (for example, see <a target="_blank" href="https://jwt.io/">JWT IO</a> or <a target="_blank" href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Token</a>).</p>

					<p>To get a good understanding of ASP.NET Core Security, review the <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/core/">documentation</a> provided by Microsoft.</p>

					<p>Additionally, you should know how the .NET <a target="_blank" href="https://docs.asp.net/en/latest/fundamentals/configuration.html">Configuration services</a> the <code>ConfigurationBuilder</code> work and how to add providers to the builder.</p>

					<p>You should also know how the ASP.NET Core <a target="_blank" href="https://docs.asp.net/en/latest/fundamentals/startup.html">Startup</a> class is used in configuring the application services and how the middleware is used by the app. Pay particular attention to the usage of the <code>Configure()</code> and <code>ConfigureServices()</code> methods.</p>

					<p>With regard to Cloud Foundry, you should have a good understanding of Cloud Foundry OAuth2 security services (such as <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity/">Pivotal Single Signon</a>) along with an understanding how they use and issue JWT.</p>

					<p>To use the JWT Security provider:</p>

					<ol>
						<li>Create and bind an instance of a Cloud Foundry OAuth2 service to your application.</li>
						<li>(Optional) Configure any additional settings the Security provider will need.</li>
						<li>Add the Cloud Foundry configuration provider to the ConfigurationBuilder.</li>
						<li>Add and Use the security provider in the application.</li>
						<li>Secure your endpoints</li>
					</ol>

					<h3 id="3-2-1-add-nuget-reference">3.2.1 Add NuGet Reference</h3>

					<p>To use the provider, add a reference to the Steeltoe Cloud Foundry Security NuGet package, <code>Steeltoe.Security.Authentication.CloudFoundryCore</code>, with the NuGet package manager or directly to your project file by using the following <code>PackageReference</code>:</p>

<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
...
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Steeltoe.Security.Authentication.CloudFoundryCore"</span> <span class="hljs-attr">Version</span>= <span class="hljs-string">"2.3.0"</span>/&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
</code></pre>

					<h3 id="3-2-2-configure-settings">3.2.2 Configure Settings</h3>

					<p>Configuring additional settings for the provider is not typically required, but, when Cloud Foundry uses self-signed certificates, you might need to disable certificate validation, as shown in the following example:</p>

<pre><code class="json hljs">{
    <span class="hljs-attr">"security"</span>: {
        <span class="hljs-attr">"oauth2"</span>: {
            <span class="hljs-attr">"client"</span>: {
                <span class="hljs-attr">"validateCertificates"</span>: <span class="hljs-literal">false</span>
            }
        }
    }
}
</code></pre>

					<p>The JWT provider uses Microsoft’s JWT implementation, and settings are based on <code>Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerOptions</code>, with these additional properties:</p>

					<table>
						<thead>
							<tr>
								<th>Name</th>
								<th>Description</th>
								<th>Default</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>validateCertificates</td>
								<td>Validate Auth server certificate</td>
								<td><code>true</code></td>
							</tr>
						</tbody>
					</table>

					<p><strong>Note</strong>: <strong>Each setting above must be prefixed with <code>security:oauth2:client</code></strong>.</p>

					<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h3 id="3-2-3-cloud-foundry">3.2.3 Cloud Foundry</h3>

					<p>As mentioned earlier. you can use a couple of OAuth2 services (such as UAA Server or Pivotal SSO) on Cloud Foundry. Rather than explaining how to create and bind OAuth2 services to your app here, we recommend that you read the documentation provided by each of the service providers.</p>

					<p>Regardless of which provider you choose, once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h3 id="3-2-4-add-cloud-foundry-jwtauthentication">3.2.4 Add Cloud Foundry JwtAuthentication</h3>

					<p>To use the provider in your application, add it to your service collection in the <code>ConfigureServices()</code> method of the <code>Startup</code> class, as shown in the following example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.Security.Authentication.CloudFoundryCore;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span> {
    ...
    <span class="hljs-keyword">public</span> IConfiguration Configuration { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Startup</span>(<span class="hljs-params">IConfiguration configuration</span>)
    </span>{
        Configuration = configuration;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)
    </span>{
        <span class="hljs-comment">// Add Cloud Foundry JWT Authentication service as the default</span>
        services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
                .AddCloudFoundryJwtBearer(Configuration);
        <span class="hljs-comment">// Add authorization policies</span>
        services.AddAuthorization(options =&gt;
        {
            options.AddPolicy(<span class="hljs-string">"Orders"</span>, policy =&gt; policy.RequireClaim(<span class="hljs-string">"scope"</span>, <span class="hljs-string">"order.me"</span>));
            options.AddPolicy(<span class="hljs-string">"AdminOrders"</span>, policy =&gt; policy.RequireClaim(<span class="hljs-string">"scope"</span>, <span class="hljs-string">"order.admin"</span>));
        });
        ...
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">IApplicationBuilder app, ...</span>)
    </span>{
        ...
        <span class="hljs-comment">// Add the authentication middleware to the pipeline</span>
        app.UseAuthentication();
    }
    ...
</code></pre>

					<p>The <code>AddCloudFoundryJwtBearer(Configuration)</code> method call configures and adds the Cloud Foundry JWT authentication service to the service container. Once in place, the authentication middleware can use it during request processing.</p>

					<h3 id="3-2-5-securing-endpoints">3.2.5 Securing Endpoints</h3>

					<p>Once you have the work done in your <code>Startup</code> class, you can then you can start to secure endpoints by using the standard ASP.NET Core <code>Authorize</code> attribute.</p>

					<p>See the Microsoft documentation on <a target="_blank" href="https://docs.asp.net/en/latest/security/">ASP.NET Core Security</a> for a better understanding of how to use these attributes.</p>

					<p>The following example shows a controller using the security attributes:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Authentication;
...

[Route(<span class="hljs-string">"api/[controller]"</span>)]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ValuesController</span> : <span class="hljs-title">Controller</span>
{
    <span class="hljs-comment">// GET api/values</span>
    [HttpGet]
    [Authorize(Policy = <span class="hljs-string">"testgroup"</span>)]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">Get</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">string</span>[] { <span class="hljs-string">"value1"</span>, <span class="hljs-string">"value2"</span> };
    }
}
</code></pre>

					<p>In the preceding example, if an incoming REST request is made to the <code>api/values</code> endpoint and the request does not contain a valid JWT bearer token with a <code>scope</code> claim equal to <code>testgroup</code>, the request is rejected.</p>

					<h2 id="3-3-usage-in-asp-net-webapi">3.3 Usage in ASP.NET WebAPI</h2>

					<p>This package is an extension of the Microsoft OWIN JWT bearer token middleware. You should take some time to understand both JWT and OWIN middlewares before proceeding to use this provider.</p>

					<p>Many resources are available for understanding JWT (for example, see <a target="_blank" href="https://jwt.io/">JWT IO</a> or <a target="_blank" href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Token</a>).</p>

					<p>To learn more about OWIN, start with the <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/an-overview-of-project-katana">Overview of Project Katana</a>.</p>

					<p>Additionally, you should know how the .NET <a target="_blank" href="https://docs.asp.net/en/latest/fundamentals/configuration.html">Configuration services</a> the <code>ConfigurationBuilder</code> work and how to add providers to the builder.</p>

					<p>With regard to Cloud Foundry, you should have a good understanding of Cloud Foundry OAuth2 security services (such as <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity/">Pivotal Single Signon</a>) along with an understanding how they use and issue JWT.</p>

					<p>To use the JWT Security provider:</p>

					<ol>
						<li>Create and bind an instance of a Cloud Foundry OAuth2 service to your application.</li>
						<li>(Optional) Configure any additional settings the Security provider will need.</li>
						<li>Add the Cloud Foundry configuration provider to the ConfigurationBuilder.</li>
						<li>Add the security provider to the OWIN pipeline in the application.</li>
						<li>Secure your endpoints</li>
					</ol>

					<h3 id="3-3-1-add-nuget-reference">3.3.1 Add NuGet Reference</h3>

					<p>To use the provider, use the NuGet package manager to add a reference to the <code>Steeltoe.Security.Authentication.CloudFoundryOwin</code> package.</p>

					<h3 id="3-3-2-configure-settings">3.3.2 Configure Settings</h3>

					<p>Configuring additional settings for the provider is not typically required, but, when Cloud Foundry uses self-signed certificates, you might need to disable certificate validation, as shown in the following example:</p>

<pre><code class="json hljs">{
    <span class="hljs-attr">"security"</span>: {
        <span class="hljs-attr">"oauth2"</span>: {
            <span class="hljs-attr">"client"</span>: {
                <span class="hljs-attr">"validateCertificates"</span>: <span class="hljs-literal">false</span>
            }
        }
    }
}
</code></pre>

					<p>The JWT provider uses Microsoft’s JWT implementation, and settings are based on <code>Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerOptions</code>, with these additional properties:</p>

					<table>
						<thead>
							<tr>
								<th>Name</th>
								<th>Description</th>
								<th>Default</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>skipAuthIfNoBoundSSOService</td>
								<td>JWT Middleware will not be added if SSO binding is not found</td>
								<td><code>true</code></td>
							</tr>
							<tr>
								<td>validateCertificates</td>
								<td>Validate Auth server certificate</td>
								<td><code>true</code></td>
							</tr>
						</tbody>
					</table>

					<p><strong>Note</strong>: <strong>Each setting above must be prefixed with <code>security:oauth2:client</code></strong>.</p>

					<p>The Steeltoe sample is set up to read from <code>appsettings.json</code>. If you require additional information, see <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<blockquote>
						<p>NOTE: The setting <code>SkipAuthIfNoBoundSSOService</code> was added in Steeltoe 2.2.0, and has a default value of <code>true</code> for backwards compatibility with previous versions. This setting was added to control functionality that was previously always-on. A future release is likely to change the default to <code>false</code> or may remove the functionality entirely.</p>
					</blockquote>

					<h3 id="3-3-3-cloud-foundry">3.3.3 Cloud Foundry</h3>

					<p>As mentioned earlier, there are two auth services (UAA Server and Pivotal SSO) on Cloud Foundry. Rather than explaining how to create and bind those services to your app here, we recommend that you read the documentation provided by each of the service providers.</p>

					<p>Regardless of which provider you choose, once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h3 id="3-3-4-add-cloud-foundry-jwtauthentication">3.3.4 Add Cloud Foundry JwtAuthentication</h3>

					<p>In order to configure the Cloud Foundry OWIN JWT provider in your application, you will need an <a target="_blank" href="https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/owin-startup-class-detection">OWIN Startup class</a> if you do not already have one, along with an <code>IConfigurationRoot</code> that includes a service binding for UAA or Pivotal SSO.</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Owin;
<span class="hljs-keyword">using</span> Steeltoe.Security.Authentication.CloudFoundry;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">CloudFoundryJwtAuthentication</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureAuth</span>(<span class="hljs-params">IAppBuilder app</span>)
        </span>{
            app.UseCloudFoundryJwtBearerAuthentication(ApplicationConfig.Configuration);
        }
   }
}
</code></pre>

					<p>The <code>UseCloudFoundryJwtBearerAuthentication(Configuration)</code> method call configures and adds the Microsoft OWIN JWT authentication middleware to the OWIN pipeline with configuration for Cloud Foundry. Once in place, the authentication middleware can use it during request processing.</p>

					<h3 id="3-3-5-securing-endpoints">3.3.5 Securing Endpoints</h3>

					<p>Once the <code>Startup</code> class is in place and the middleware is configured, you can use the standard ASP.NET <code>Authorize</code> attribute to require authentication.</p>

					<p>The <code>CloudFoundryJwtAuthentication</code> sample demonstrates extending the AuthorizeAttribute with a <a target="_blank" href="https://github.com/SteeltoeOSS/Samples/blob/dev/Security/src/AspDotNet4/CloudFoundryJwtAuthentication/CustomClaimsAuthorizeAttribute.cs">CustomClaimsAuthorizeAttribute</a> to require a given claim on an endpoint in a straightforward way. The following example shows a controller using the <code>CustomClaimsAuthorizeAttribute</code>:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Web.Http;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ValuesController</span> : <span class="hljs-title">ApiController</span>
{
    <span class="hljs-comment">// GET: api/Values</span>
    [CustomClaimsAuthorize(<span class="hljs-string">"testgroup"</span>)]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">Get</span>(<span class="hljs-params"></span>)
    </span>{
        Console.WriteLine(<span class="hljs-string">"Received GET Request"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">string</span>[] { <span class="hljs-string">"value1"</span>, <span class="hljs-string">"value2"</span> };
    }
}
</code></pre>

					<p>In the preceding example, if an incoming REST request is made to the <code>api/values</code> endpoint and the request does not contain a valid JWT bearer token with a <code>scope</code> claim equal to <code>testgroup</code>, the request is rejected.</p>

					<h2 id="3-4-usage-in-asp-net-wcf">3.4 Usage in ASP.NET WCF</h2>

					<p>This package is a custom authorization provider for using JWT Bearer tokens in Windows Communication Foundation (WCF) applications. The provider is built on <code>System.IdentityModel.Claims</code>. You should take some time to understand both JWT and WCF security before proceeding to use this provider.</p>

					<p>Many resources are available for understanding JWT (for example, see <a target="_blank" href="https://jwt.io/">JWT IO</a> or <a target="_blank" href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Token</a>).</p>

					<p>Additionally, you should know how the .NET <a target="_blank" href="https://docs.asp.net/en/latest/fundamentals/configuration.html">Configuration services</a> the <code>ConfigurationBuilder</code> work and how to add providers to the builder.</p>

					<p>With regard to Cloud Foundry, you should have a good understanding of Cloud Foundry OAuth2 security services (such as <a target="_blank" href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a target="_blank" href="https://docs.pivotal.io/p-identity/">Pivotal Single Signon</a>) along with an understanding how they use and issue JWT.</p>

					<p>To use the JWT Security provider:</p>

					<ol>
						<li>Create and bind an instance of a Cloud Foundry OAuth2 service to your application.</li>
						<li>(Optional) Configure any additional settings the Security provider will need.</li>
						<li>Add the Cloud Foundry configuration provider to the ConfigurationBuilder.</li>
						<li>Configure JwtAuthorizationManager as the ServiceAuthorizationManger for the server application.</li>
						<li>Secure your endpoints</li>
						<li>Update your WCF client(s) to include JWTs in the request</li>
					</ol>

					<h3 id="3-4-1-add-nuget-reference">3.4.1 Add NuGet Reference</h3>

					<p>To use the provider, use the NuGet package manager to add a reference to the <code>Steeltoe.Security.Authentication.CloudFoundryWcf</code> package in both your client and server applications.</p>

					<h3 id="3-4-2-configure-settings">3.4.2 Configure Settings</h3>

					<p>Configuring additional settings for the provider is not typically required, but, when Cloud Foundry uses self-signed certificates, you might need to disable certificate validation, as shown in the following example:</p>

<pre><code class="json hljs">{
    <span class="hljs-attr">"security"</span>: {
        <span class="hljs-attr">"oauth2"</span>: {
            <span class="hljs-attr">"client"</span>: {
                <span class="hljs-attr">"validateCertificates"</span>: <span class="hljs-literal">false</span>
            }
        }
    }
}
</code></pre>

					<p>The Steeltoe sample is set up to read from <code>appsettings.json</code>, if you require additional information, see <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<table>
						<thead>
							<tr>
								<th>Name</th>
								<th>Description</th>
								<th>Default</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>forwardUserCredentials</td>
								<td>Whether to use app credentials or forward users’s credentials</td>
								<td><code>false</code></td>
							</tr>
							<tr>
								<td>validateAudience</td>
								<td>Whether or not a token’s audience should be validated</td>
								<td><code>true</code></td>
							</tr>
							<tr>
								<td>validateIssuer</td>
								<td>Whether or not a token’s issuer should be validated</td>
								<td><code>true</code></td>
							</tr>
							<tr>
								<td>validateLifeTime</td>
								<td>Whether or not a token’s lifetime should be validated</td>
								<td><code>true</code></td>
							</tr>
							<tr>
								<td>validateCertificates</td>
								<td>Validate Auth server certificate</td>
								<td><code>true</code></td>
							</tr>
						</tbody>
					</table>

					<h3 id="3-4-3-cloud-foundry">3.4.3 Cloud Foundry</h3>

					<p>As mentioned earlier. you can use a couple of OAuth2 services (such as UAA Server or Pivotal SSO) on Cloud Foundry. Rather than explaining how to create and bind OAuth2 services to your app here, we recommend that you read the documentation provided by each of the service providers.</p>

					<p>Regardless of which provider you choose, once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h3 id="3-4-4-set-serviceauthorizationmanager">3.4.4 Set ServiceAuthorizationManager</h3>

					<p>To configure the Cloud Foundry JWT provider for your WCF service, provide your <code>IConfiguration</code> to the <code>AddJwtAuthorization</code> extension, as shown in the following example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.Security.Authentication.CloudFoundry.Wcf;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.ServiceModel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Global</span> : <span class="hljs-title">System</span>.<span class="hljs-title">Web</span>.<span class="hljs-title">HttpApplication</span>
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Application_Start</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)
    </span>{
        ApplicationConfig.RegisterConfig(<span class="hljs-string">"development"</span>);
        <span class="hljs-keyword">var</span> serviceHost = <span class="hljs-keyword">new</span> ServiceHost(<span class="hljs-keyword">typeof</span>(ValueService));
        serviceHost.AddJwtAuthorization(ApplicationConfig.Configuration);
    }
}
</code></pre>

					<blockquote>
						<p>NOTE: The above is not the only way to configure the JwtAuthorizationManager. WCF can be configured many ways, which are beyond the scope of this documentation.</p>
					</blockquote>

					<h3 id="3-4-5-securing-endpoints">3.4.5 Securing Endpoints</h3>

					<p>Inside your WCF service, apply claims rules to endpoints with the <code>ScopePermission</code> attribute, as seen in this example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.Security.Authentication.CloudFoundry.Wcf;
<span class="hljs-keyword">using</span> System.Security.Permissions;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">CloudFoundryWcf</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ValueService</span> : <span class="hljs-title">IValueService</span>
    {
        [ScopePermission(SecurityAction.Demand, Scope = <span class="hljs-string">"testgroup"</span>)]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-title">GetData</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello from the WCF Sample!"</span>;
        }
    }
}
</code></pre>

					<h3 id="3-4-6-updating-client-to-send-jwt">3.4.6 Updating Client to Send JWT</h3>

					<p>
						In order to include a JWT in the request to a WCF service, you will need to apply an EndpointBehavior. The <code>JwtHeaderEndpointBehavior</code> is provided for you in the CloudFoundryWcf package.
						The <code>JwtHeaderEndpointBehavior</code> can be configured to pass a user’s credentials forward to backing services, or to get a token on behalf of the application (Client Credentials flow).
					</p>

					<p>The default behavior of the library is the Client Credentials flow. The <a target="_blank" href="https://github.com/SteeltoeOSS/Security/blob/dev/src/Steeltoe.Security.Authentication.CloudFoundryWcf/CloudFoundryOptions.cs">CloudFoundryOptions</a> required by the <code>JwtHeaderEndpointBehavior</code> can be configured several ways:</p>

					<ol>
						<li>
							From an <code>IConfiguration</code>

							<ul>
								<li><code>new CloudFoundryOptions(configuration)</code></li>
								<li>Settings bound from the subsection defined as <code>security:oauth2:client</code></li>
							</ul>
						</li>
						<li>
							Inline

							<ul>
								<li><code>new CloudFoundryOptions {  ClientId = "client-id", ClientSecret = "client-secret" }</code>)</li>
							</ul>
						</li>
						<li>
							From environment variables

							<ul>
								<li>
									<code>new CloudFoundryOptions()</code>

									<ul>
										<li>Auth domain is set with <code>sso_auth_domain</code></li>
										<li>Client Id is set with <code>sso_client_id</code></li>
										<li>Client Secret is set with <code>sso_client_secret</code></li>
									</ul>
								</li>
							</ul>
						</li>
					</ol>

					<p>Regardless of the method chosen for instantiating the <code>CloudFoundryOptions</code>, the code to apply the behavior should look something like this:</p>

<pre><code class="csharp hljs">
    <span class="hljs-comment">// create an instance of the WCF client</span>
    <span class="hljs-keyword">var</span> sRef = <span class="hljs-keyword">new</span> ValueService.ValueServiceClient();

    <span class="hljs-comment">// apply the behavior, expecting it to manage and pass the token for the application</span>
    sRef.Endpoint.EndpointBehaviors.Add(<span class="hljs-keyword">new</span> JwtHeaderEndpointBehavior(<span class="hljs-keyword">new</span> CloudFoundryOptions(configuration)));
    <span class="hljs-keyword">string</span> serviceResponse = <span class="hljs-keyword">await</span> sRef.GetDataAsync();
</code></pre>

					<p>To pass a user’s token (instead of the application’s) to the backing service, first set <code>security:oauth2:client:forwardUserCredentials</code> to <code>true</code> in your configuration. You will also need to retrieve the user’s token and pass that into the <code>JwtHeaderEndpointBehavior</code> when making requests, as seen in this example:</p>

<pre><code class="csharp hljs">
    <span class="hljs-comment">// retrieve the user's token</span>
    <span class="hljs-keyword">var</span> token = Request.GetOwinContext().Authentication.User.Claims.First(c =&gt; c.Type == ClaimTypes.Authentication)?.Value;

    <span class="hljs-comment">// create an instance of the WCF client</span>
    <span class="hljs-keyword">var</span> sRef = <span class="hljs-keyword">new</span> ValueService.ValueServiceClient(binding, address);

    <span class="hljs-comment">// apply the behavior, including the user's token</span>
    sRef.Endpoint.EndpointBehaviors.Add(<span class="hljs-keyword">new</span> JwtHeaderEndpointBehavior(<span class="hljs-keyword">new</span> CloudFoundryOptions(ApplicationConfig.Configuration), token));
    <span class="hljs-keyword">string</span> serviceResponse = <span class="hljs-keyword">await</span> sRef.GetDataAsync();
</code></pre>

					<h1 id="4-0-redis-key-storage-provider">4.0 Redis Key Storage Provider</h1>

					<p><span style="display:inline-block;margin:0 20px;">For use with </span><span style="display:inline-block;vertical-align:top;width:40%"> <img src="./Security_files/CFF_Logo_rgb.png" title="Cloud Foundry" alt="alt text"></span></p>

					<p>By default, ASP.NET Core stores the key ring on the local file system. Local file system usage in a Cloud Foundry environment is unworkable and violates the <a target="_blank" href="https://12factor.net/">twelve-factor guidelines</a> for developing cloud native applications. By using the Steeltoe Redis Key Storage provider, you can reconfigure the Data Protection service to use Redis on Cloud Foundry for storage.</p>

					<p>To use this provider:</p>

					<ol>
						<li>Create a Redis Service instance and bind it to your application.</li>
						<li>Add the Steeltoe Cloud Foundry config provider to your <code>ConfigurationBuilder</code>.</li>
						<li>Add the Redis <code>ConnectionMultiplexer</code> to your ServiceCollection.</li>
						<li>Add <code>DataProtection</code> to your <code>ServiceCollection</code> and configure it to <code>PersistKeysToRedis</code>.</li>
					</ol>

					<h3 id="4-2-1-add-nuget-reference">4.2.1 Add NuGet Reference</h3>

					<p>To use the provider, add a reference to the Steeltoe DataProtection Redis NuGet.</p>

					<p>The provider can be found in the <code>Steeltoe.Security.DataProtection.RedisCore</code> package.</p>

					<p>You can add the provider to your project by using the following <code>PackageReference</code> in your project file:</p>

<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
...
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Steeltoe.Security.DataProtection.RedisCore"</span> <span class="hljs-attr">Version</span>= <span class="hljs-string">"2.3.0"</span>/&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
</code></pre>

					<p>You also need the Steeltoe Redis connector. Add the <code>Steeltoe.CloudFoundry.ConnectorCore</code> package to get the Redis connector and helpers for setting it up.</p>

					<p>You can use the NuGet Package Manager tools or directly add the following package reference to your .csproj file:</p>

<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
...
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Steeltoe.CloudFoundry.ConnectorCore"</span> <span class="hljs-attr">Version</span>= <span class="hljs-string">"2.3.0"</span>/&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
</code></pre>

					<h3 id="4-2-2-cloud-foundry">4.2.2 Cloud Foundry</h3>

					<p>To use the Redis Data Protection key ring provider on Cloud Foundry, you have to install a Redis service and create and bind an instance of it to your application by using the Cloud Foundry command line, as shown in the following example:</p>

<pre><code class="bash hljs"><span class="hljs-comment"># Create Redis service</span>
cf create-service p-redis shared-vm myRedisCache

<span class="hljs-comment"># Bind service to `myApp`</span>
cf <span class="hljs-built_in">bind</span>-service myApp myRedisCache

<span class="hljs-comment"># Restage the app to pick up change</span>
cf restage myApp
</code></pre>

					<blockquote>
						<p>NOTE: The preceding commands are for the Redis service provided by Pivotal on Cloud Foundry. If you use a different service, you have to adjust the <code>create-service</code> command.</p>
					</blockquote>

					<p>Once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h3 id="4-2-3-add-redis-iconnectionmultiplexer">4.2.3 Add Redis IConnectionMultiplexer</h3>

					<p>The next step is to add the StackExchange Redis <code>IConnectionMultiplexer</code> to your service container.</p>

					<p>You can do so in the <code>ConfigureServices()</code> method of the <code>Startup</code> class by using the Steeltoe Redis Connector, as follows:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.CloudFoundry.Connector.Redis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span> {
    ...
    <span class="hljs-keyword">public</span> IConfiguration Configuration { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Startup</span>(<span class="hljs-params">IConfiguration configuration</span>)
    </span>{
        Configuration = configuration;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)
    </span>{
        <span class="hljs-comment">// Add StackExchange ConnectionMultiplexer configured from Cloud Foundry</span>
        services.AddRedisConnectionMultiplexer(Configuration);

        <span class="hljs-comment">// Add framework services.</span>
        services.AddMvc();
        ...
    }
    ...
</code></pre>

					<p>See the documentation on the <a href="https://steeltoe.io/docs/steeltoe-connectors/#5-2-2-configure-settings">Steeltoe Redis connector</a> for details on how you can configure additional settings to control its behavior.</p>

					<h3 id="4-2-4-add-persistkeystoredis">4.2.4 Add PersistKeysToRedis</h3>

					<p>The last step is to use the provider to configure DataProtection to persist keys to Redis.</p>

					<p>You can do so in the <code>ConfigureServices()</code> method of the <code>Startup</code> class, as shown in the following example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.CloudFoundry.Connector.Redis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span> {
    ...
    <span class="hljs-keyword">public</span> IConfiguration Configuration { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Startup</span>(<span class="hljs-params">IConfiguration configuration</span>)
    </span>{
        Configuration = configuration;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)
    </span>{
        <span class="hljs-comment">// Add StackExchange ConnectionMultiplexer configured from Cloud Foundry</span>
        services.AddRedisConnectionMultiplexer(Configuration);

        <span class="hljs-comment">// Add DataProtection and persist keys to Cloud Foundry Redis service</span>
        services.AddDataProtection()
            .PersistKeysToRedis()
            .SetApplicationName(<span class="hljs-string">"Some Name"</span>);

        <span class="hljs-comment">// Add framework services.</span>
        services.AddMvc();
        ...
    }
    ...
</code></pre>

					<h3 id="4-2-5-use-redis-key-store">4.2.5 Use Redis Key Store</h3>

					<p>Once the Redis Key Store has been set up, the keys used by the <code>DataProtection</code> framework are stored in the bound Redis Cloud Foundry service. You need not do more.</p>

					<h1 id="5-0-credhub-api-client">5.0 CredHub API Client</h1>

					<p><a target="_blank" href="https://github.com/cloudfoundry-incubator/credhub">CredHub</a> manages credentials such as  passwords, certificates, certificate authorities, ssh keys, rsa keys, and other arbitrary values. Steeltoe provides the <code>CredHubBase</code> library for interacting with the <a target="_blank" href="https://credhub-api.cfapps.io/">CredHub API</a> and provides the <code>CredHubCore</code> library for making that client library simpler to use in ASP.NET Core applications. Cloud Foundry is not required for the CredHub server or client but is used in this documentation as the hosting environment. You may wish to review the documentation for <a target="_blank" href="https://docs.pivotal.io/pivotalcf/2-0/credhub/">CredHub on PCF</a>. If you do not already have a UAA user to use for this test, you will need to use the UAA command line tool to establish some security credentials for the sample app. Choose one of the provided <code>credhub-setup</code> scripts in the folder <code>samples/Security/scripts</code> to target your Cloud Foundry environment and create a UAA client with permissions to read and write in CredHub.</p>

					<blockquote>
						<p>NOTE: If you choose to change the values for <code>UAA_CLIENT_ID</code> or <code>UAA_CLIENT_SECRET</code>, be sure to update the credentials in appsettings.json</p>
					</blockquote>

					<!--  -->

					<blockquote>
						<p>WARNING: As of this writing, CredHub is not approved for general use in all applications. We encourage you to check whether your use case is currently supported by CredHub before getting too involved.</p>
					</blockquote>

					<p>To use the Steeltoe CredHub Client, you must:</p>

					<ul>
						<li>Have access to a CredHub Server (the client was built against version 1.6.5).</li>
						<li>Have UAA credentials for accessing the server with sufficient permissions for your use case</li>
						<li>Use the provided methods and constructors to create, inject, or utilize the client.</li>
					</ul>

					<h3 id="5-2-1-add-nuget-reference">5.2.1 Add NuGet Reference</h3>

					<p>To use this library with ASP.NET Core, add a NuGet reference to <code>Steeltoe.Security.DataProtection.CredHubCore</code>. For other application types, use <code>Steeltoe.Security.DataProtection.CredHubBase</code>. Most of the functionality resides in <code>CredHubBase</code>. The purpose of <code>CredHubCore</code> is to provide additional methods for a simpler experience when using ASP.NET Core.</p>

					<p>Use the NuGet package manager tools or directly add the appropriate package to your project using the a <code>PackageReference</code>, as follows:</p>

<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
...
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Steeltoe.Security.DataProtection.CredHubCore"</span> <span class="hljs-attr">Version</span>= <span class="hljs-string">"2.3.0"</span>/&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
</code></pre>

					<h3 id="5-2-2-configure-settings">5.2.2 Configure Settings</h3>

					<p>Settings for this library are expected to have a prefix of <code>CredHubClient</code>. The following example shows what that looks like in JSON:</p>

<pre><code class="json hljs">
{
  ...
    <span class="hljs-attr">"credHubClient"</span>: {
    <span class="hljs-attr">"validateCertificates"</span>: <span class="hljs-string">"false"</span>
  }
  ...
}
</code></pre>

					<p>The <code>CredHubClient</code> supports four settings:</p>

					<table>
						<thead>
							<tr>
								<th>Setting Name</th>
								<th>Description</th>
								<th>Default</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>CredHubUrl</td>
								<td>The address of the CredHub API</td>
								<td><a target="_blank" href="https://credhub.service.cf.internal:8844/api">https://credhub.service.cf.internal:8844/api</a></td>
							</tr>
							<tr>
								<td>CredHubUser</td>
								<td>The username for UAA auth</td>
								<td><code>null</code></td>
							</tr>
							<tr>
								<td>CredHubPassword</td>
								<td>The password for UAA auth</td>
								<td><code>null</code></td>
							</tr>
							<tr>
								<td>ValidateCertificates</td>
								<td>Whether to validate certificates for UAA and/or CredHub servers</td>
								<td><code>true</code></td>
							</tr>
						</tbody>
					</table>

					<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>

					<h3 id="5-2-3-on-cloud-foundry">5.2.3 On Cloud Foundry</h3>

					<p>Pivotal Cloud Foundry (in versions 2.0 and up) ships with a version of CredHub Server with which this client works. To use UAA authentication, you will need a user with <code>credhub.read</code> and/or <code>credhub.write</code> claims.</p>

					<h3 id="5-2-4-getting-a-client">5.2.4 Getting a Client</h3>

					<p>There are several ways to create a <code>CredHubClient</code>, depending on whether you want to use Microsoft’s dependency injection. Regardless of the creation method selected, once the client has been created, all functionality is the same.</p>

					<h4 id="5-2-4-1-create-and-inject-client">5.2.4.1 Create and Inject Client</h4>

					<p>If you use Microsoft’s Dependency injection framework, you can use <code>IServiceCollection.AddCredHubClient()</code> to create, configure, and inject <code>CredHubClient</code>, as shown in the folloowing example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">using</span> Steeltoe.Security.DataProtection.CredHubCore;
...
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span>
{
    ILoggerFactory logFactory;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Startup</span>(<span class="hljs-params">IConfiguration configuration, ILoggerFactory logFactory</span>)
    </span>{
        Configuration = configuration;
        <span class="hljs-keyword">this</span>.logFactory = logFactory;
    }
    <span class="hljs-keyword">public</span> IConfiguration Configuration { <span class="hljs-keyword">get</span>; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)
    </span>{
        services.AddMvc();
        services.AddCredHubClient(Configuration, logFactory);
    }
    ...
}
...
</code></pre>

					<h4 id="5-2-4-2-create-uaa-client">5.2.4.2 Create UAA Client</h4>

					<p>You can use <code>CredHubClient.CreateUAAClientAsync()</code> to directly create a CredHub client that authenticates with a username and password that is valid on the UAA server CredHub is configured to trust. This client calls <code>/info</code> on the CredHub server to discover the UAA server’s address and appends <code>/oauth/token</code> when requesting a token. The following listing shows how to do it:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">var</span> credHubClient = <span class="hljs-keyword">await</span> CredHubClient.CreateUAAClientAsync(<span class="hljs-keyword">new</span> CredHubOptions());
</code></pre>

					<blockquote>
						<p>NOTE: If you need to override the UAA server address, use the <code>UAA_Server_Override</code> environment variable, making sure to include the path to the token endpoint.</p>
					</blockquote>

					<h4 id="5-2-4-3-interpolation-only">5.2.4.3 Interpolation-Only</h4>

					<p>If you wish to use CredHub to interpolate entries in <code>VCAP_SERVICES</code>, you can use <code>WebHostBuilder.UseCredHubInterpolation()</code>. This method looks for <code>credhub-ref</code> in <code>VCAP_SERVICES</code> and uses a <code>CredHubClient</code> to replace the credential references with credentials stored in CredHub but does not return the <code>CredHubClient</code>. The following example shows how to do it:</p>

<pre><code class="csharp hljs">    <span class="hljs-keyword">var</span> host = <span class="hljs-keyword">new</span> WebHostBuilder()
        .UseKestrel()
        .UseCloudFoundryHosting()
        .UseContentRoot(Directory.GetCurrentDirectory())
        .UseIISIntegration()
        .UseStartup&lt;Startup&gt;()
        .ConfigureAppConfiguration((builderContext, config) =&gt;
        {
            config.SetBasePath(builderContext.HostingEnvironment.ContentRootPath)
                .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">false</span>, reloadOnChange: <span class="hljs-literal">true</span>)
                .AddJsonFile(<span class="hljs-string">$"appsettings.<span class="hljs-subst">{builderContext.HostingEnvironment.EnvironmentName}</span>.json"</span>, optional: <span class="hljs-literal">true</span>)
                .AddCloudFoundry()
                .AddEnvironmentVariables();
        })
        .ConfigureLogging((builderContext, loggingBuilder) =&gt;
        {
            loggingBuilder.AddConfiguration(builderContext.Configuration.GetSection(<span class="hljs-string">"Logging"</span>));
            loggingBuilder.AddDynamicConsole();
        })
        .UseCredHubInterpolation(<span class="hljs-keyword">new</span> LoggerFactory().AddConsole())
        .Build();
</code></pre>

					<h3 id="5-2-4-credential-types">5.2.4 Credential Types</h3>

					<p>These are the .NET representations of credentials that can be stored in CredHub. Refer to the <a target="_blank" href="https://credhub-api.cfapps.io/">CredHub documentation</a> for more detail.</p>

					<h4 id="5-2-4-1-valuecredential">5.2.4.1 ValueCredential</h4>

					<p>Any string can be used for a <code>ValueCredential</code>. CredHub allows Get, Set, Delete, and Find operations with <code>ValueCredential</code></p>

					<h4 id="5-2-4-2-passwordcredential">5.2.4.2 PasswordCredential</h4>

					<p>Any string can be used for a <code>PasswordCredential</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>PasswordCredential</code></p>

					<h4 id="5-2-4-3-usercredential">5.2.4.3 UserCredential</h4>

					<p>A <code>UserCredential</code> has <code>string</code> properties for <code>Username</code> and <code>Password</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>UserCredential</code>. Regenerate operations do not regenerate the username.</p>

					<h4 id="5-2-4-4-jsoncredential">5.2.4.4 JsonCredential</h4>

					<p>Any JSON object can be used for a <code>JsonCredential</code>. CredHub allows Get, Set, Delete, and Find operations with <code>JsonCredential</code>.</p>

					<h4 id="5-2-4-5-certificatecredential">5.2.4.5 CertificateCredential</h4>

					<p>A <code>CertificateCredential</code> represents a security certificate. CredHub allows Get, Set, Delete, Find, Generate, Regenerate, and Bulk Regenerate operations with <code>CertificateCredential</code>. The following table describes specific properties:</p>

					<table>
						<thead>
							<tr>
								<th>Property</th>
								<th>Description</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>CertificateAuthority</td>
								<td>The certificate of the Certificate Authority</td>
							</tr>
							<tr>
								<td>CertificateAuthorityName</td>
								<td>The name of the CA credential in credhub that has signed this certificate</td>
							</tr>
							<tr>
								<td>Certificate</td>
								<td>The string representation of the certificate</td>
							</tr>
							<tr>
								<td>PrivateKey</td>
								<td>The private key for the certificate</td>
							</tr>
						</tbody>
					</table>

					<h4 id="5-2-4-6-rsacredential">5.2.4.6 RsaCredential</h4>

					<p>The <code>RsaCredential</code> has string properties for <code>PublicKey</code> and <code>PrivateKey</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>RsaCredential</code>.</p>

					<h4 id="5-2-4-7-sshcredential">5.2.4.7 SshCredential</h4>

					<p>The <code>SshCredential</code> has string properties for <code>PublicKey</code>, <code>PrivateKey</code>, and <code>PublicKeyFingerprint</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>SshCredential</code>.</p>

					<h3 id="5-2-5-credhub-read-operations">5.2.5 CredHub Read Operations</h3>

					<p>All <code>CredHubClient</code> Read operations operate asynchronously and do not change the credentials or permissions stored in CredHub. Refer to the <a target="_blank" href="https://credhub-api.cfapps.io/">CredHub documentation</a> for more detail. For brevity, the samples shown later in this guide use <code>_credHubClient</code> to reference an instance of <code>CredHubClient</code> that has been created previously. See <a href="#4-2-4-getting-a-client">Getting a Client</a> for instructions on how to create a <code>CredHubClient</code>.</p>

					<h4 id="5-2-5-1-get-by-id">5.2.5.1 Get by ID</h4>

					<p>You can use <code>await _credHubClient.GetByIdAsync&lt;CredentialType&gt;(credentialId)</code> to retrieve a credential by its <code>Guid</code>. Only the current credential value is returned.</p>

					<h4 id="5-2-5-2-get-by-name">5.2.5.2 Get by Name</h4>

					<p>You can use <code>await _credHubClient.GetByNameAsync&lt;CredentialType&gt;(credentialName)</code> to retrieve a credential by its <code>Name</code>. Only the current credential value is returned.</p>

					<h4 id="5-2-5-3-get-by-name-with-history">5.2.5.3 Get by Name with History</h4>

					<p>You can use <code>await _credHubClient.GetByNameWithHistoryAsync&lt;CredentialType&gt;(credentialName, numEntries)</code> to retrieve a credential by name with the most recent <code>numEntries</code> holding the number of entries.</p>

					<h4 id="5-2-5-4-find-by-name">5.2.5.4 Find by Name</h4>

					<p>You can use <code>await _credHubClient.FindByNameAsync(credentialName)</code> to retrieve a list of <code>FoundCredential</code> objects that are either a full or partial match for the name searched. The <code>FoundCredential</code> type includes only the <code>Name</code> and <code>VersionCreatedAt</code> properties, so follow-up requests are expected to retrieve credential details.</p>

					<h4 id="5-2-5-5-find-by-path">5.2.5.5 Find by Path</h4>

					<p>You can use <code>await _credHubClient.FindByPathAsync(path)</code> to retrieve a list of <code>FoundCredential</code> objects that are either a full or partial match for the name searched. The <code>FoundCredential</code> type includes only the <code>Name</code> and <code>VersionCreatedAt</code> properties, so follow-up requests are expected to retrieve credential details. Use the <code>/</code> path value to return all accessible credentials.</p>

					<h4 id="5-2-5-6-find-all-paths">5.2.5.6 Find All Paths</h4>

					<p>You can use <code>await _credHub.FindAllPathsAsync()</code> to retrieve a list of all known credential paths.</p>

					<h4 id="5-2-5-7-interpolate">5.2.5.7 Interpolate</h4>

					<p>One of the more powerful features of CredHub is the <code>Interpolate</code> endpoint. With one request, you may retrieve N number of credentials that have been stored in CredHub. To use it from .NET, call <code>await _credHub.InterpolateServiceDataAsync(serviceData)</code>, where <code>serviceData</code> is the string representation of <code>VCAP_SERVICES</code>. <code>CredHubClient</code> returns the interpolated <code>VCAP_SERVICES</code> data as a string. If you wish to have the interpolated data applied to your application configuration, see <a href="#4-2-4-4-interpolation-only">the .UseCredHubInterpolation() documentation</a></p>

					<p>The following example shows a typical request object for the <code>Interpolate</code> endpoint:</p>

<pre><code class="json hljs">{
    <span class="hljs-attr">"p-demo-resource"</span>: [
    {
        <span class="hljs-attr">"credentials"</span>: {
            <span class="hljs-attr">"credhub-ref"</span>: <span class="hljs-string">"((/config-server/credentials))"</span>
        },
        <span class="hljs-attr">"label"</span>: <span class="hljs-string">"p-config-server"</span>,
        <span class="hljs-attr">"name"</span>: <span class="hljs-string">"config-server"</span>,
        <span class="hljs-attr">"plan"</span>: <span class="hljs-string">"standard"</span>,
        <span class="hljs-attr">"provider"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">"syslog_drain_url"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">"tags"</span>: [
            <span class="hljs-string">"configuration"</span>,
            <span class="hljs-string">"spring-cloud"</span>
        ],
        <span class="hljs-attr">"volume_mounts"</span>: []
    }
  ]
}
</code></pre>

					<p>The following example shows a typical response object from the <code>Interpolate</code> endpoint:</p>

<pre><code class="json hljs">{
    <span class="hljs-attr">"p-demo-resource"</span>: [
        {
            <span class="hljs-attr">"credentials"</span>: {
                <span class="hljs-attr">"key"</span>: <span class="hljs-number">123</span>,
                <span class="hljs-attr">"key_list"</span>: [
                    <span class="hljs-string">"val1"</span>,
                    <span class="hljs-string">"val2"</span>
                ],
                <span class="hljs-attr">"is_true"</span>: <span class="hljs-literal">true</span>
            },
            <span class="hljs-attr">"label"</span>: <span class="hljs-string">"p-config-server"</span>,
            <span class="hljs-attr">"name"</span>: <span class="hljs-string">"config-server"</span>,
            <span class="hljs-attr">"plan"</span>: <span class="hljs-string">"standard"</span>,
            <span class="hljs-attr">"provider"</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">"syslog_drain_url"</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">"tags"</span>: [
                <span class="hljs-string">"configuration"</span>,
                <span class="hljs-string">"spring-cloud"</span>
            ],
            <span class="hljs-attr">"volume_mounts"</span>: []
        }
    ]
}
</code></pre>

					<blockquote>
						<p>NOTE: At this time, only credential references at <code>credentials.credhub-ref</code> are interpolated. The <code>credhub-ref</code> key is removed and the referenced credential object is set as the value of the credentials.</p>
					</blockquote>

					<h3 id="5-2-6-credhub-change-operations">5.2.6 CredHub Change Operations</h3>

					<p>All <code>CredHubClient</code> Change operations operate asynchronously and affect stored credentials. Refer to the <a target="_blank" href="https://credhub-api.cfapps.io/">CredHub documentation</a> for more detail. For brevity, the samples shown later in this guide use <code>_credHubClient</code> to reference an instance of <code>CredHubClient</code> that has been created previously. See <a href="#4-2-4-getting-a-client">Getting a Client</a> for instructions on how to create a <code>CredHubClient</code>.</p>

					<h4 id="5-2-6-1-write">5.2.6.1 Write</h4>

					<p>If you already have a credential that you want to store in CredHub, use a <code>Write</code> request. <code>CredHubClient.WriteAsync&lt;T&gt;()</code> expects a request object that descends from <code>CredentialSetRequest</code>. There is a <code>[Type]SetRequest</code> class for each credential type (<code>ValueSetRequest</code>, <code>PasswordSetRequest</code>, and so on). The SetRequest family of classes includes optional parameters for overwriting existing values and setting permissions, in addition to value properties for the credential. Include the type of credential you want to write to CredHub in the T parameter so the compiler knows the return type. The following example shows a typical <code>Write</code> request:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">var</span> setValueRequest = <span class="hljs-keyword">new</span> ValueSetRequest(<span class="hljs-string">"sampleValueCredential"</span>, <span class="hljs-string">"someValue"</span>);
<span class="hljs-comment">// set the value of credential "/sampleValueCredential" to "someValue" if there is NOT an existing value</span>
<span class="hljs-keyword">var</span> setValue1 = <span class="hljs-keyword">await</span> _credHub.WriteAsync&lt;ValueCredential&gt;(setValueRequest);

<span class="hljs-comment">// set the value of credential "/sampleValueCredential" to "someValue" even if there is an existing value</span>
setValueRequest.Overwrite = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">var</span> setValue2 = <span class="hljs-keyword">await</span> _credHub.WriteAsync&lt;ValueCredential&gt;(setValueRequest);
</code></pre>

					<blockquote>
						<p>NOTE: The default behavior on <code>Write</code> requests is to leave existing values alone. If you wish to overwrite a credential, be sure to pass either <code>OverwriteMode.converge</code> or <code>OverwriteMode.overwrite</code> for the <code>overwriteMode</code> parameter on your request object. See <a target="_blank" href="https://credhub-api.cfapps.io/#overwriting-credential-values">Overwriting Credential Values</a>.</p>
					</blockquote>

					<p>Write requests allow the setting of permissions on a credential during generation, as shown in the following example:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">var</span> desiredOperations = <span class="hljs-keyword">new</span> List&lt;OperationPermissions&gt;
                        {
                            OperationPermissions.read,
                            OperationPermissions.write,
                            OperationPermissions.delete
                        };
<span class="hljs-keyword">var</span> newPerms = <span class="hljs-keyword">new</span> CredentialPermission { Actor = <span class="hljs-string">"uaa-user:credhub_client"</span>, Operations = desiredOperations };
<span class="hljs-keyword">var</span> setRequest = <span class="hljs-keyword">new</span> ValueSetRequest(<span class="hljs-string">"sampleValueCredential"</span>, <span class="hljs-string">"someValue"</span>, <span class="hljs-keyword">new</span> List&lt;CredentialPermission&gt; { newPerms });
<span class="hljs-keyword">var</span> setValue = <span class="hljs-keyword">await</span> _credHub.WriteAsync&lt;ValueCredential&gt;(setRequest);
</code></pre>

					<h4 id="5-2-7-2-generate">5.2.7.2 Generate</h4>

					<p>You can generate a new credential or overwrite an existing credential with a new generated value. CredHub is able to generate values for the following types: <code>CertificateCredential</code>, <code>PasswordCredential</code>, <code>RsaCredential</code>, <code>SshCredential</code>, and <code>UserCredential</code>. <code>CredHubClient.GenerateAsync&lt;T&gt;()</code> expects a request object that descends from <code>CredHubGenerateRequest</code>. There is a <code>[Type]GenerateRequest</code> class for each supported credential type (<code>CertificateGenerationRequest</code>, <code>PasswordGenerationRequest</code>, <code>RsaGenerationRequest</code>, and so on). Most of the <code>GenerateRequest</code> family of classes include a <code>[Type]GenerationParameters</code> parameter for specifying criteria for generating the credential. The following example shows how to generate a credential:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">var</span> genParameters = <span class="hljs-keyword">new</span> PasswordGenerationParameters { Length = <span class="hljs-number">20</span> };
<span class="hljs-keyword">var</span> genRequest = <span class="hljs-keyword">new</span> PasswordGenerationRequest(<span class="hljs-string">"generatedPassword"</span>, genParameters);
CredHubCredential&lt;PasswordCredential&gt; genPassword = <span class="hljs-keyword">await</span> _credHub.GenerateAsync&lt;PasswordCredential&gt;(genRequest);
</code></pre>

					<p>The following example demonstrates that <code>Generate</code> requests allow the setting of permissions on a credential during generation:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">var</span> genParams = <span class="hljs-keyword">new</span> PasswordGenerationParameters { Length = <span class="hljs-number">20</span> };
<span class="hljs-keyword">var</span> desiredOperations = <span class="hljs-keyword">new</span> List&lt;OperationPermissions&gt;
                        {
                            OperationPermissions.read,
                            OperationPermissions.write,
                            OperationPermissions.delete
                        };
<span class="hljs-keyword">var</span> newPerms = <span class="hljs-keyword">new</span> CredentialPermission { Actor = <span class="hljs-string">"uaa-user:credhub_client"</span>, Operations = desiredOperations };
<span class="hljs-keyword">var</span> genRequest = <span class="hljs-keyword">new</span> PasswordGenerationRequest(<span class="hljs-string">"generatedPW"</span>, genParams, <span class="hljs-keyword">new</span> List&lt;CredentialPermission&gt; { newPerms });
CredHubCredential&lt;PasswordCredential&gt; genPassword = <span class="hljs-keyword">await</span> _credHub.GenerateAsync&lt;PasswordCredential&gt;(genRequest);
</code></pre>

					<blockquote>
						<p>NOTE: The default behavior on <code>Generate</code> requests is to leave existing values alone. If you wish to overwrite a credential, be sure to pass either <code>OverwriteMode.converge</code> or <code>OverwriteMode.overwrite</code> for the <code>overwriteMode</code> parameter on your request object. See <a target="_blank" href="https://credhub-api.cfapps.io/#overwriting-credential-values">Overwriting Credential Values</a>.</p>
					</blockquote>

					<h4 id="5-2-6-3-regenerate">5.2.6.3 Regenerate</h4>

					<p>You can regenerate a credential in CredHub. CredHub can generate values for the following types: <code>CertificateCredential</code>, <code>PasswordCredential</code>, <code>RsaCredential</code>, <code>SshCredential</code>, and <code>UserCredential</code>.</p>

					<blockquote>
						<p>NOTE: Only credentials that were previously generated by CredHub can be regenerated.</p>
					</blockquote>

					<p>The following example shows one way to regenerate a credential:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">var</span> regeneratedCert = <span class="hljs-keyword">await</span> _credHub.RegenerateAsync&lt;CertificateCredential&gt;(<span class="hljs-string">"/MyGeneratedCert"</span>);
</code></pre>

					<h4 id="5-2-6-4-bulk-regenerate">5.2.6.4 Bulk Regenerate</h4>

					<p>You can regenerate all certificates that were previously generated by CredHub with a given certificate authority. The following example returns a list of <code>RegeneratedCertificates</code> which contains the credential names as a <code>List&lt;string&gt;</code> property named RegeneratedCredentials:</p>

<pre><code class="csharp hljs">RegeneratedCertificates bulkRegenerate = <span class="hljs-keyword">await</span> _credHub.BulkRegenerateAsync(<span class="hljs-string">"NameThatCA"</span>);
</code></pre>

					<h4 id="5-2-6-5-delete-by-name">5.2.6.5 Delete by Name</h4>

					<p>You can delete a credential by its full name. The following example returns a boolean indicating success or failure:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">bool</span> deleteCertificate = <span class="hljs-keyword">await</span> _credHub.DeleteByNameAsync(<span class="hljs-string">"/MyPreviouslyGeneratedCertificate"</span>);
</code></pre>

					<h3 id="5-2-7-permission-operations">5.2.7 Permission Operations</h3>

					<p>CredHub supports permissions management on credential access for UAA users. See the <a target="_blank" href="https://credhub-api.cfapps.io/#permissions">offical CredHub Permissions documentation</a>.</p>

					<h4 id="5-2-7-1-get-permissions">5.2.7.1 Get Permissions</h4>

					<p>You can get the permissions associated with a credential, as shown in the following example:</p>

<pre><code class="csharp hljs">List&lt;CredentialPermission&gt; response = <span class="hljs-keyword">await</span> _credHub.GetPermissionsAsync(<span class="hljs-string">"/example-password"</span>);
</code></pre>

					<h4 id="5-2-7-2-add-permissions">5.2.7.2 Add Permissions</h4>

					<p>You can add permissions to an existing credential. The following example eturns the updated list of permissions for the specified credential:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">var</span> desiredOps = <span class="hljs-keyword">new</span> List&lt;OperationPermissions&gt; { OperationPermissions.read, OperationPermissions.write };
<span class="hljs-keyword">var</span> newActorPermissions = <span class="hljs-keyword">new</span> CredentialPermission { Actor = <span class="hljs-string">"uaa-user:credhub_client"</span>, Operations = desiredOps };
<span class="hljs-keyword">var</span> newPerms = <span class="hljs-keyword">new</span> List&lt;CredentialPermission&gt; { newActorPermissions };
List&lt;CredentialPermission&gt; response = <span class="hljs-keyword">await</span> _credHub.AddPermissionsAsync(<span class="hljs-string">"/example-password"</span>, newPerms);
</code></pre>

					<h4 id="5-2-7-3-delete-permissions">5.2.7.3 Delete Permissions</h4>

					<p>You can delete a permission associated with a credential. The following example returns a boolean indicating success or failure:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">bool</span> response = <span class="hljs-keyword">await</span> _credHub.DeletePermissionAsync(<span class="hljs-string">"/example-password"</span>, <span class="hljs-string">"uaa-user:credhub_client"</span>);
</code></pre>

					<h1 id="common-steps">Common Steps</h1>

					<h2 id="set-up-uaa">Set up UAA</h2>

					<h3 id="get-uaa-cli">Get UAA CLI</h3>

					<p>Before creating a security service instance, you can use the UAA command line tool to establish some security credentials for your sample application.</p>

					<p>To install the UAA command line tool and target your UAA server, you first need to <a target="_blank" href="https://www.ruby-lang.org/en/documentation/installation/">install Ruby on your system</a>. Once Ruby is installed, you can install the UAA CLI by using the following command:</p>

<pre><code class="bash hljs">gem install cf-uaac
</code></pre>

					<h3 id="get-admin-client-token">Get Admin Client Token</h3>

					<p>Next, using the UAA CLI, you can authenticate and obtain an access token for the <code>admin client</code> from the UAA server so that you can add the quick start application and user credentials.</p>

					<p>To accomplish this, you need the <code>Admin Client Secret</code> for your installation of Cloud Foundry.</p>

					<p>If you use Pivotal Cloud Foundry (PCF), you can obtain this secret from the <code>Ops Manager/Elastic Runtime</code> credentials page under the <code>UAA</code> section. Look for <code>Admin Client Credentials</code> and then use it in the following commands:</p>

<pre><code class="bash hljs"><span class="hljs-comment"># Target the UAA on Cloud Foundry</span>
uaac target uaa.`YOUR-CLOUDFOUNDRY-SYSTEM-DOMAIN` <span class="hljs-comment"># (for example, `uaac target uaa.system.testcloud.com`)</span>

<span class="hljs-comment"># Obtain an Admin Client Access Token</span>
uaac token client get admin <span class="hljs-_">-s</span> `ADMIN_CLIENT_SECRET`
</code></pre>

					<h3 id="add-user-and-group">Add User and Group</h3>

					<p>Next, you need to add a new <code>user</code> and <code>group</code> to the UAA Server database.</p>

					<p>Do <em>not</em> change the group name, <code>testgroup</code>, as that is used for policy based authorization in the quick start sample. You can change the username and password to anything you like. The following commands show how to add a test group, add a user, add the user to the test group:</p>

<pre><code class="bash hljs"><span class="hljs-comment"># Add group `testgroup`</span>
uaac group add testgroup

<span class="hljs-comment"># Add user `dave`</span>
uaac user add dave --given_name Dave --family_name Tillman --emails dave@testcloud.com --password Password1!

<span class="hljs-comment"># Add `dave` to `testgroup`</span>
uaac member add testgroup dave
</code></pre>

					<h3 id="add-application-client">Add Application Client</h3>

					<p>Next, add the quick start application as a new client for the UAA server to enable it to interact with the UAA server, as follows:</p>

<pre><code class="bash hljs">uaac client add myTestApp --scope cloud_controller.read,cloud_controller_service_permissions.read,openid,testgroup \
        --authorized_grant_types authorization_code,refresh_token \
        --authorities uaa.resource \
        --redirect_uri https://single-signon.`YOUR-CLOUDFOUNDRY-APP-DOMAIN`/signin-cloudfoundry,https://single-signon.`YOUR-CLOUDFOUNDRY-APP-DOMAIN`/signin-cloudfoundry \
        --autoapprove cloud_controller.read,cloud_controller_service_permissions.read,openid,testgroup \
        --secret myTestApp
</code></pre>

					<blockquote>
						<p>NOTE: Replace <code>YOUR-CLOUDFOUNDRY-APP-DOMAIN</code> with your Cloud Foundry setup domain!</p>
					</blockquote>

					<h3 id="create-service">Create Service</h3>

					<p>Finally, create a user-provided service on Cloud Foundry to provide the appropriate UAA server configuration data to the application.</p>

					<p>You may either use the provided <code>credentials.json</code> file when creating the service or provide the parameters inline. Either way, you must replace the <code>YOUR-CLOUDFOUNDRY-SYSTEM-DOMAIN</code> with your Cloud Foundry setup domain.</p>

					<p>Once you have created a way to provide credentials, use the following commands:</p>

<pre><code class="bash hljs"><span class="hljs-comment"># Create CUPs service with JSON file:</span>
cf cups myOAuthService -p credentials.json
<span class="hljs-comment"># Create service with inline JSON:</span>
cf cups myOAuthService -p <span class="hljs-string">"{\"client_id\": \"myTestApp\",\"client_secret\": \"myTestApp\",\"uri\": \"uaa://login.&lt;YOUR-CLOUDFOUNDRY-SYSTEM-DOMAIN&gt;\"}"</span>
</code></pre>

					<blockquote>
						<p>NOTE: The quote type and escaping for inline JSON varies based on which terminal you use, so you may have to adjust the preceding commands.</p>
					</blockquote>

					<h2 id="publish-sample">Publish Sample</h2>

					<h3 id="asp-net-core">ASP.NET Core</h3>

					<p>Use the <code>dotnet</code> CLI to <a target="_blank" href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-publish">build and locally publish</a> the application for the framework and runtime you will deploy the application to:</p>

					<ul>
						<li>Linux with .NET Core: <code>dotnet publish -f netcoreapp2.1 -r ubuntu.14.04-x64</code></li>
						<li>Windows with .NET Core: <code>dotnet publish -f netcoreapp2.1 -r win10-x64</code></li>
						<li>Windows with .NET Platform: <code>dotnet publish -f net461 -r win10-x64</code></li>
					</ul>

					<blockquote>
						<p>NOTE: Starting with .NET Core 2.0, the <code>dotnet publish</code> command will automatically restore dependencies for you. Running <code>dotnet restore</code> explicitly is not generally required.</p>
					</blockquote>

					<h3 id="asp-net-4-x">ASP.NET 4.x</h3>

					<ol>
						<li>Open the solution for the sample in Visual Studio</li>
						<li>Right click on the project, select “Publish”</li>
						<li>Use the included <code>FolderProfile</code> to publish to <code>bin/Debug/net461/win10-x64/publish</code></li>
					</ol>

					<h2 id="push-sample">Push Sample</h2>

					<p>Use the Cloud Foundry CLI to push the published application to Cloud Foundry using the parameters that match what you selected for framework and runtime, as follows:</p>

<pre><code class="bash hljs"><span class="hljs-comment"># Push to Linux cell</span>
cf push <span class="hljs-_">-f</span> manifest.yml -p bin/Debug/netcoreapp2.1/ubuntu.14.04-x64/publish

					<span class="hljs-comment"># Push to Windows cell, .NET Core</span>
cf push <span class="hljs-_">-f</span> manifest-windows.yml -p bin/Debug/netcoreapp2.1/win10-x64/publish

					<span class="hljs-comment"># Push to Windows cell, .NET Framework</span>
cf push <span class="hljs-_">-f</span> manifest-windows.yml -p bin/Debug/net461/win10-x64/publish
</code></pre>

					<blockquote>
						<p>NOTE: All sample manifests have been defined to bind their application to their service(s) as created above.</p>
					</blockquote>

					<h2 id="observe-logs">Observe Logs</h2>

					<p>To see the logs as you startup the application, use <code>cf logs oauth</code>.</p>

					<p>On a Linux cell, you should see something resembling the following during startup:</p>

<pre><code class="bash hljs">2016-06-01T09:14:14.38-0600 [CELL/0]     OUT Creating container
2016-06-01T09:14:15.93-0600 [CELL/0]     OUT Successfully created container
2016-06-01T09:14:17.14-0600 [CELL/0]     OUT Starting health monitoring of container
2016-06-01T09:14:21.04-0600 [APP/0]      OUT Hosting environment: Development
2016-06-01T09:14:21.04-0600 [APP/0]      OUT Content root path: /home/vcap/app
2016-06-01T09:14:21.04-0600 [APP/0]      OUT Now listening on: http://*:8080
2016-06-01T09:14:21.04-0600 [APP/0]      OUT Application started. Press Ctrl+C to shut down.
2016-06-01T09:14:21.41-0600 [CELL/0]     OUT Container became healthy
</code></pre>

					<p>On Windows cells, you should see something slightly different but with the same information.</p>

					<h2 id="reading-configuration-values">Reading Configuration Values</h2>

					<p>Once settings have been defined, the next step is to read them so that they can be made available.</p>

					<p>The code in the next example reads settings from the <code>appsettings.json</code> file with the .NET JSON configuration provider (<code>AddJsonFile("appsettings.json"))</code> and from <code>VCAP_SERVICES</code> with <code>AddCloudFoundry()</code>. Both sources are then added to the configuration builder. The following code shows how to read from both sources:</p>

<pre><code class="csharp hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span> {
    ...
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IWebHost <span class="hljs-title">BuildWebHost</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> WebHostBuilder()
            ...
            .UseCloudFoundryHosting()
            ...
            .ConfigureAppConfiguration((builderContext, configBuilder) =&gt;
            {
                <span class="hljs-keyword">var</span> env = builderContext.HostingEnvironment;
                configBuilder.SetBasePath(env.ContentRootPath)
                    .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">true</span>, reloadOnChange: <span class="hljs-literal">true</span>)
                    .AddJsonFile(<span class="hljs-string">$"appsettings.<span class="hljs-subst">{env.EnvironmentName}</span>.json"</span>, optional: <span class="hljs-literal">true</span>)
                    .AddEnvironmentVariables()
                    <span class="hljs-comment">// Add the Cloudfoundry VCAP settings to configuration</span>
                    .AddCloudFoundry();
            })
            .Build();
    }
    ...
</code></pre>

					<p>When pushing the application to Cloud Foundry, the settings from service bindings merge with the settings from other configuration mechanisms (such as <code>appsettings.json</code>).</p>

					<p>If there are merge conflicts, the last provider added to the Configuration takes precedence and overrides all others.</p>

					<p>To manage application settings centrally instead of with individual files, use <a href="https://steeltoe.io/docs/steeltoe-configuration">Steeltoe Configuration</a> and a tool such as <a target="_blank" href="https://github.com/spring-cloud/spring-cloud-config">Spring Cloud Config Server</a></p>

					<blockquote>
						<p>NOTE: If you use the Spring Cloud Config Server, <code>AddConfigServer()</code> automatically calls <code>AddCloudFoundry()</code> for you.</p>
					</blockquote>

					<a class="repo-link" target="_blank" href="https://github.com/steeltoeoss/steeltoe-site/tree/dev/source/docs/steeltoe-security.html.markdown">Create a pull request or raise an issue on the source for this page in GitHub</a>
				</div>
			</div>
		</div>
	</div>
	<script src="/javascripts/vendor/gumshoe.js"></script>
	<script src="/javascripts/vendor/highlight.min.js"></script>
	<script src="/javascripts/vendor/jquery-3.1.1.slim.min.js"></script>
	<script src="/javascripts/vendor/particles.min.js"></script>
	<script src="/javascripts/vendor/smooth-scroll.js"></script>
	<script src="/javascripts/vendor/sticky-kit.min.js"></script>
	<script src="/javascripts/vendor/svg-injector.min.js"></script>
	<script src="/javascripts/vendor/tocbot.min.js"></script>
	<script src="/javascripts/all.js"></script>
	<script src="/javascripts/docs.js"></script>
	<script>
		function viewV1() {
			window.location.href = '/1x/steeltoe-configuration/';
		}
					//document.getElementById('docselector').style.display = "inline";
	</script>


</body>
</html>