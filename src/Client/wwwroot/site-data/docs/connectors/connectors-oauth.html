<h1 id="oauth">OAuth</h1>
<p>This connector simplifies using Cloud Foundry OAuth2 security services (for example, <a href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a href="https://docs.pivotal.io/p-identity/">Pivotal Single Sign-on</a>) by exposing the Cloud Foundry OAuth service configuration data as injectable <code>IOption&lt;OAuthServiceOptions&gt;</code>. It is used by the <a href="../steeltoe-security">Cloud Foundry External Security Providers</a> but can be used separately.</p>
<h2 id="usage">Usage</h2>
<p>You should know how the new .NET <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration">Configuration service</a> works before starting to use the connector. To configure the connector, you need a basic understanding of the <code>ConfigurationBuilder</code> and how to add providers to the builder.</p>
<p>You should also know how the ASP.NET Core <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/startup">Startup</a> class is used in configuring the application services for the application. Pay particular attention to the usage of the <code>ConfigureServices()</code> method.</p>
<p>You probably want some understanding of Cloud Foundry OAuth2 security services (such as <a href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a href="https://docs.pivotal.io/p-identity/">Pivotal Single Sign-on</a>) before starting to use this connector.</p>
<p>To use this Connector:</p>
<ol>
<li>Create an OAuth service instance and bind it to your application.</li>
<li>(Optional) Configure any additional settings the OAuth connector needs.</li>
<li>Add the Steeltoe Cloud Foundry configuration provider to your ConfigurationBuilder.</li>
<li>Add the OAuth connector to your ServiceCollection.</li>
<li>Access the OAuth service options.</li>
</ol>
<h3 id="add-nuget-reference">Add NuGet Reference</h3>
<p>To use the OAuth connector, you need to add a reference to the appropriate <a href="#add-nuget-references">Steeltoe Connector NuGet package</a>.</p>
<h3 id="configure-settings">Configure Settings</h3>
<p>Configuring additional settings for the connector is not typically required, but, when Cloud Foundry uses self-signed certificates, you might need to disable certificate validation, as shown in the following example:</p>
<pre><code class="language-json">{
  ...
  &quot;security&quot;: {
    &quot;oauth2&quot;: {
      &quot;client&quot;: {
        &quot;validateCertificates&quot;: false
      }
    }
  }
  ...
}
</code></pre>
<blockquote class="blockquote">
<p>CAUTION: Self-signed certificates are inherently insecure. Never use them for a production environment.</p>
</blockquote>
<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<h3 id="cloud-foundry">Cloud Foundry</h3>
<p>There are multiple ways to set up OAuth services on Cloud Foundry.</p>
<p>In the <a href="#6-1-quick-start">quick start</a>, we used a user-provided service to define a direct binding to the Cloud Foundry UAA server. Alternatively, you can use the <a href="https://docs.pivotal.io/p-identity/">Pivotal Single Sign-on</a>) product to provision an OAuth service binding. The process to create service binding varies for each of the approaches.</p>
<p>Regardless of which you choose, once the service is bound to your application, the connector's settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<h3 id="add-oauthserviceoptions">Add OAuthServiceOptions</h3>
<p>Once the OAuth service has been bound to the application, add the OAuth connector to your service collection in the <code>ConfigureServices()</code> method of the <code>Startup</code> class, as shown in the following example:</p>
<pre><code class="language-csharp">using Steeltoe.CloudFoundry.Connector.OAuth;

public class Startup {
    ...
    public IConfiguration Configuration { get; private set; }
    public Startup(...)
    {
      ...
    }
    public void ConfigureServices(IServiceCollection services)
    {
        // Configure and Add IOptions&lt;OAuthServiceOptions&gt; to the container
        services.AddOAuthServiceOptions(Configuration);

        // Add framework services.
        services.AddMvc();
        ...
    }
    ...
</code></pre>
<p>The <code>AddOAuthServiceOptions(Configuration)</code> method call configures a <code>OAuthServiceOptions</code> instance by using the configuration built by the application and adds it to the service container.</p>
<h3 id="use-oauthserviceoptions">Use OAuthServiceOptions</h3>
<p>Finally, you can inject and use the configured <code>OAuthServiceOptions</code> into a controller, as shown in the following example:</p>
<pre><code class="language-csharp">using Steeltoe.CloudFoundry.Connector.OAuth;
...
public class HomeController : Controller
{
    OAuthServiceOptions _options;

    public HomeController(IOptions&lt;OAuthServiceOptions&gt; oauthOptions)
    {
        _options = oauthOptions.Value;
    }
    ...
    public IActionResult OAuthOptions()
    {
        ViewData[&quot;ClientId&quot;] = _options.ClientId;
        ViewData[&quot;ClientSecret&quot;] = _options.ClientSecret;
        ViewData[&quot;UserAuthorizationUrl&quot;] = _options.UserAuthorizationUrl;
        ViewData[&quot;AccessTokenUrl&quot;] = _options.AccessTokenUrl;
        ViewData[&quot;UserInfoUrl&quot;] = _options.UserInfoUrl;
        ViewData[&quot;TokenInfoUrl&quot;] = _options.TokenInfoUrl;
        ViewData[&quot;JwtKeyUrl&quot;] = _options.JwtKeyUrl;
        ViewData[&quot;ValidateCertificates&quot;] = _options.ValidateCertificates;
        ViewData[&quot;Scopes&quot;] = CommaDelimit(_options.Scope);

        return View();
    }
}
</code></pre>
