<h1 id="postgresql">PostgreSQL</h1>
<p>This connector simplifies using PostgreSQL in an application running on Cloud Foundry.</p>
<p>Currently, the connector supports the <a href="https://www.npgsql.org/">Npgsql</a> provider.</p>
<p>This connector provides a <code>IHealthContributor</code> which you can use in conjunction with the <a href="https://steeltoe.io/docs/steeltoe-management/#1-2-3-health">Steeltoe Management Health</a> check endpoint.  See the <a href="#using-health-contributors">Using Health Contributors</a> section for details on how to make use of it.</p>
<p>You can find the source code for this connector <a href="https://github.com/SteeltoeOSS/Connectors">here</a>.</p>
<h2 id="usage">Usage</h2>
<p>You should know how the new .NET <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration">Configuration service</a> works before starting to use the connector. You need a basic understanding of the <code>ConfigurationBuilder</code> and how to add providers to the builder to configure the connector.</p>
<p>You should also know how the ASP.NET Core <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/startup">Startup</a> class is used to configure the application services for the app. Pay particular attention to the <code>ConfigureServices()</code> method.</p>
<p>To use this connector:</p>
<ol>
<li>Create a PostgreSQL Service instance and bind it to your application.</li>
<li>Optionally, configure any PostgreSQL client settings (such as <code>appsettings.json</code>).</li>
<li>Add the Steeltoe Cloud Foundry config provider to your <code>ConfigurationBuilder</code>.</li>
<li>Add <code>NpgsqlConnection</code> or <code>DbContext</code> to your <code>IServiceCollection</code>.</li>
</ol>
<h3 id="add-nuget-reference">Add NuGet Reference</h3>
<p>To use the PostgreSQL connector, add your choice of PostgreSQL package between <a href="https://www.nuget.org/packages/Npgsql/">Npgsql</a> and <a href="https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL/">Npgsql.EntityFrameworkCore.PostgreSQL</a> as you would if you weren't using Steeltoe. Then, add a reference to the appropriate <a href="#add-nuget-references">Steeltoe Connector NuGet package</a>.</p>
<blockquote class="blockquote">
<p>NOTE: Steeltoe does not currently include direct support for PostgreSQL with Entity Framework 6</p>
</blockquote>
<h3 id="configure-settings">Configure Settings</h3>
<p>The PostgreSQL connector supports several settings for creating the <code>NpgsqlConnection</code> to a database. This can be useful when you develop and test an application locally and need to configure the connector for non-default settings.</p>
<p>The following example shows a PostgreSQL connector configuration (in JSON) to set up a connection to a database at <code>myserver:5432</code>:</p>
<pre><code class="language-json">{
  ...
  &quot;postgres&quot;: {
    &quot;client&quot;: {
      &quot;host&quot;: &quot;myserver&quot;,
      &quot;port&quot;: 5432
    }
  }
  ...
}
</code></pre>
<p>The following table describes all of the possible settings for the connector:</p>
<table class="table">
<thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>server</td>
<td>Hostname or IP Address of server</td>
<td>localhost</td>
</tr>
<tr>
<td>port</td>
<td>Port number of server</td>
<td>5432</td>
</tr>
<tr>
<td>username</td>
<td>Username for authentication</td>
<td>not set</td>
</tr>
<tr>
<td>password</td>
<td>Password for authentication</td>
<td>not set</td>
</tr>
<tr>
<td>database</td>
<td>Schema to which to connect</td>
<td>not set</td>
</tr>
<tr>
<td>connectionString</td>
<td>Full connection string</td>
<td>built from settings</td>
</tr>
<tr>
<td>urlEncodedCredentials</td>
<td>Set to <code>true</code> if your service broker provides URL-encoded credentials</td>
<td>false</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p>IMPORTANT: All of these settings should be prefixed with <code>postgres:client:</code>.</p>
</blockquote>
<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<blockquote class="blockquote">
<p>NOTE: If a ConnectionString is provided and VCAP_SERVICES are not detected (a typical scenario for local app development), the ConnectionString will be used exactly as provided.</p>
</blockquote>
<h3 id="cloud-foundry">Cloud Foundry</h3>
<p>To use PostgreSQL on Cloud Foundry, after a PostgreSQL service is installed, you can create and bind an instance of it to your application by using the Cloud Foundry CLI, as follows:</p>
<pre><code class="language-bash"># Create PostgreSQL service
cf create-service EDB-Shared-PostgreSQL &quot;Basic PostgreSQL Plan&quot; myPostgres

# Bind service to `myApp`
cf bind-service myApp myPostgres

# Restage the app to pick up change
cf restage myApp
</code></pre>
<blockquote class="blockquote">
<p>NOTE: The preceding commands work for the PostgreSQL service provided by EDB on Cloud Foundry. For another service, adjust the <code>create-service</code> command to fit your environment.</p>
</blockquote>
<p>Version 2.1.1+ of this connector works with the <a href="https://docs.pivotal.io/partners/azure-open-service-broker-pcf/index.html">Azure Open Service Broker for PCF</a>. Be sure to set <code>postgres:client:urlEncodedCredentials</code> to <code>true</code> as this broker may provide credentials that have been URL Encoded.</p>
<p>Once the service is bound to your application, the connector's settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<h3 id="add-npgsqlconnection">Add NpgsqlConnection</h3>
<p>To use a <code>NpgsqlConnection</code> in your application, add it to the service container in the <code>ConfigureServices()</code> method of the <code>Startup</code> class, as shown in the following example:</p>
<pre><code class="language-csharp">using Steeltoe.CloudFoundry.Connector.PostgreSql;

public class Startup {
    ...
    public IConfiguration Configuration { get; private set; }
    public Startup(...)
    {
      ...
    }
    public void ConfigureServices(IServiceCollection services)
    {
        // Add NpgsqlConnection configured from Cloud Foundry
        services.AddPostgresConnection(Configuration);

        // Add framework services.
        services.AddMvc();
        ...
    }
    ...
</code></pre>
<p>The <code>AddPostgresConnection(Configuration)</code> method call configures the <code>NpgsqlConnection</code> by using the configuration built by the application and adds the connection to the service container.</p>
<h3 id="use-npgsqlconnection">Use NpgsqlConnection</h3>
<p>Once the connection is configured and added to the service container, you can inject and use in a controller or a view, as shown in the following example:</p>
<pre><code class="language-csharp">using Npgsql;
...
public class HomeController : Controller
{
    public IActionResult PostgresData([FromServices] NpgsqlConnection dbConnection)
    {
        dbConnection.Open();

        NpgsqlCommand cmd = new NpgsqlCommand(&quot;SELECT * FROM TestData;&quot;, dbConnection);
        var rdr = cmd.ExecuteReader();

        while (rdr.Read())
        {
            ViewData[&quot;Key&quot; + rdr[0]] = rdr[1];
        }

        rdr.Close();
        dbConnection.Close();

        return View();
    }
}

</code></pre>
<h3 id="add-dbcontext">Add DbContext</h3>
<p>To use Entity Framework, inject and use a <code>DbContext</code> in your application instead of a <code>NpgsqlConnection</code> through the <code>AddDbContext&lt;&gt;()</code> method, as shown in the following example:</p>
<pre><code class="language-csharp">using Steeltoe.CloudFoundry.Connector.PostgreSql.EFCore;

public class Startup {
    public IConfiguration Configuration { get; private set; }
    public Startup(...)
    {
      ...
    }
    public void ConfigureServices(IServiceCollection services)
    {
        // Add EFCore TestContext configured with a PostgreSQL configuration
        services.AddDbContext&lt;TestContext&gt;(options =&gt; options.UseNpgsql(Configuration));

        // Add framework services.
        services.AddMvc();
        ...
    }
</code></pre>
<p>The <code>AddDbContext&lt;TestContext&gt;(options =&gt; options.UseNpgsql(Configuration));</code> method call configures the <code>TestContext</code> by using the configuration built by the application and adds the context to the service container.</p>
<p>The following example shows how you would define the <code>DbContext</code>:</p>
<pre><code class="language-csharp">using Microsoft.EntityFrameworkCore;
...

public class TestContext : DbContext
{
    public TestContext(DbContextOptions options) : base(options)
    {
    }
    public DbSet&lt;TestData&gt; TestData { get; set; }
}
</code></pre>
<p>If you need to set additional properties for the <code>DbContext</code> like <code>MigrationsAssembly</code> or connection retry settings, create an <code>Action&lt;NpgsqlDbContextOptionsBuilder&gt;</code> like this:</p>
<pre><code class="language-csharp">Action&lt;NpgsqlDbContextOptionsBuilder&gt; npgsqlOptionsAction = (o) =&gt;
{
  o.MigrationsAssembly(typeof(Startup).GetTypeInfo().Assembly.GetName().Name);
  // Configuring Connection Resiliency: https://docs.microsoft.com/en-us/ef/core/miscellaneous/connection-resiliency
  o.EnableRetryOnFailure(maxRetryCount: 15, maxRetryDelay: TimeSpan.FromSeconds(30), errorNumbersToAdd: null);
};
</code></pre>
<p>Pass your new options action into the AddDbContext method:</p>
<pre><code class="language-csharp">services.AddDbContext&lt;TestContext&gt;(options =&gt; options.UseNpgsql(Configuration, npgsqlOptionsAction));
</code></pre>
<h3 id="use-dbcontext">Use DbContext</h3>
<p>Once you have configured and added the context to the service container, you can inject and use it in a controller or a view, as shown in the following example:</p>
<pre><code class="language-csharp">using Project.Models;
...
public class HomeController : Controller
{
    public IActionResult PostgresData([FromServices] TestContext context)
    {
        return View(context.TestData.ToList());
    }
}
</code></pre>
