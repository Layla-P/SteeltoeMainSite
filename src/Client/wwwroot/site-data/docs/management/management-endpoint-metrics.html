<h3 id="metrics">Metrics</h3>
<p>The Steeltoe Metrics endpoint configures application metrics collection using the open source <a href="https://opencensus.io/">OpenCensus</a> project. It automatically configures built-in instrumentation of various aspects of the application and exposes the collected metrics via the endpoint.</p>
<p>The following instrumentation is automatically configured:</p>
<ul>
<li>CLR Metrics
<ul>
<li>Heap memory, Garbage collections, Thread utilization</li>
</ul>
</li>
<li>HTTP Client Metrics
<ul>
<li>Request timings &amp; counts</li>
</ul>
</li>
<li>HTTP Server Metrics
<ul>
<li>Request timings &amp; counts</li>
</ul>
</li>
</ul>
<p>All of the above metrics are tagged with values specific to the requests being processed; thereby giving multi-dimensional views of the collected metrics.</p>
<blockquote class="blockquote">
<p>NOTE: The OpenCensus implementation used in Steeltoe (for example, <code>Steeltoe.Management.OpenCensus</code>) has been contributed to the OpenCensus community. At some point in the near future the metrics collection functionality will move to using it, instead of the Steeltoe version.</p>
</blockquote>
<h4 id="configure-settings">Configure Settings</h4>
<p>The following table describes the settings that you can apply to the endpoint:</p>
<table class="table">
<thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>The ID of the metrics endpoint</td>
<td><code>metrics</code></td>
</tr>
<tr>
<td>enabled</td>
<td>Whether to enable the metrics management endpoint</td>
<td>true</td>
</tr>
<tr>
<td>ingressIgnorePattern</td>
<td>Regex pattern describing what incoming requests to ignore</td>
<td>See <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.EndpointBase/Metrics/MetricsOptions.cs">MetricsOptions</a></td>
</tr>
<tr>
<td>egressIgnorePattern</td>
<td>Regex pattern describing what outgoing requests to ignore</td>
<td>See <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.EndpointBase/Metrics/MetricsOptions.cs">MetricsOptions</a></td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: <strong>Each setting above must be prefixed with <code>management:endpoints:metrics</code></strong>.</p>
<h4 id="enable-http-access">Enable HTTP Access</h4>
<p>The default path to the Metrics endpoint is computed by combining the global <code>path</code> prefix setting together with the <code>id</code> setting from above. The default path is <code>/metrics</code>.</p>
<p>The coding steps you take to enable HTTP access to the Metrics endpoint differs depending on the type of .NET application your are developing.  The sections which follow describe the steps needed for each of the supported application types.</p>
<h5 id="asp.net-core-app">ASP.NET Core App</h5>
<p>Refer to the <a href="#http-access-asp-net-core">HTTP Access ASP.NET Core</a> section below to see the overall steps required to enable HTTP access to endpoints in an ASP.NET Core application.</p>
<p>To add the Metrics actuator to the service container, use the <code>AddMetricsActuator()</code> extension method from <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.EndpointCore/Metrics/EndpointServiceCollectionExtensions.cs">EndpointServiceCollectionExtensions</a>.</p>
<p>To add the Mappings actuator middleware to the ASP.NET Core pipeline, use the <code>UseMetricsActuator()</code> extension method from <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.EndpointCore/Metrics/EndpointApplicationBuilderExtensions.cs">EndpointApplicationBuilderExtensions</a>.</p>
<h5 id="asp.net-4.x-app">ASP.NET 4.x App</h5>
<p>Refer to the <a href="#http-access-asp-net-4-x">HTTP Access ASP.NET 4.x</a> section below to see the overall steps required to enable HTTP access to endpoints in a 4.x application.</p>
<p>To add the Metrics actuator endpoint, use the <code>UseMetricsActuator()</code> method from <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.EndpointWeb/ActuatorConfigurator.cs">ActuatorConfigurator</a>.</p>
<h5 id="asp.net-owin-app">ASP.NET OWIN App</h5>
<p>Refer to the <a href="#http-access-asp-net-owin">HTTP Access ASP.NET OWIN</a> section below to see the overall steps required to enable HTTP access to endpoints in an ASP.NET 4.x OWIN application.</p>
<p>To add the Metrics actuator middleware to the ASP.NET OWIN pipeline, use the <code>UseMetricsActuator()</code> extension method from <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.EndpointOwin/Metrics/MappingsEndpointAppBuilderExtensions.cs">MetricsEndpointAppBuilderExtensions</a>.</p>
<h4 id="exporting">Exporting</h4>
<p>By default when you enable metrics collection in your application you do <em>NOT</em> automatically enable exporting of those metrics to a backend system.</p>
<p>The coding steps you take to enable metrics exporting differs depending on what backend system you are targeting and the type of .NET application your are developing.  The sections which follow describe the steps needed for each of the backend systems and supported application types.</p>
<h5 id="add-nuget-references">Add NuGet References</h5>
<p>To use the metrics exporters, you need to add a reference to the appropriate Steeltoe NuGet based on the type of the application you are building and what Dependency Injector you have chosen, if any.</p>
<p>The following table describes the available packages:</p>
<table class="table">
<thead>
<tr>
<th>App Type</th>
<th>Package</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>All</td>
<td><code>Steeltoe.Management.ExporterBase</code></td>
<td>Base functionality, no dependency injection</td>
</tr>
<tr>
<td>ASP.NET Core</td>
<td><code>Steeltoe.Management.ExporterCore</code></td>
<td>Includes <code>ExporterBase</code>, adds ASP.NET Core DI</td>
</tr>
</tbody>
</table>
<p>To add this type of NuGet to your project, add a <code>PackageReference</code> resembling the following:</p>
<pre><code class="language-xml">&lt;ItemGroup&gt;
...
    &lt;PackageReference Include=&quot;Steeltoe.Management.ExporterCore&quot; Version= &quot;2.1.0&quot;/&gt;
...
&lt;/ItemGroup&gt;
</code></pre>
<p>or</p>
<pre><code class="language-powershell">PM&gt;Install-Package  Steeltoe.Management.ExporterCore -Version 2.1.0
</code></pre>
<h5 id="cloud-foundry-forwarder">Cloud Foundry Forwarder</h5>
<p>The <a href="https://docs.pivotal.io/metrics-forwarder/">Metrics Forwarder for Pivotal Cloud Foundry (PCF)</a> is a service that allows apps to emit metrics to the <a href="https://docs.pivotal.io/pivotalcf/2-2/loggregator/architecture.html">Loggregator</a> system and consume those metrics from the <a href="https://docs.pivotal.io/pivotalcf/2-2/loggregator/architecture.html#firehose">Loggregator Firehose</a>.</p>
<p>You can interact with the service through the Cloud Foundry Command Line Interface (cf CLI), <a href="https://docs.pivotal.io/pivotalcf/2-0/console/manage-apps.html">Pivotal Apps Manager</a>, and an <a href="https://docs.pivotal.io/metrics-forwarder/api/">HTTP API</a>. See the <a href="https://docs.pivotal.io/metrics-forwarder/using.html">documentation</a> for details on how to use the service in your application.</p>
<p><a href="https://docs.pivotal.io/metrics-forwarder/">Metrics Forwarder for Pivotal Cloud Foundry (PCF)</a>  enables users to do the following:</p>
<ul>
<li>Configure apps to emit custom metrics to <a href="https://docs.pivotal.io/pivotalcf/2-2/loggregator/architecture.html">Loggregator</a> system.</li>
<li>Read custom metrics from the <a href="https://docs.pivotal.io/pivotalcf/2-2/loggregator/architecture.html#firehose">Loggregator Firehose</a> using a Firehose consumer of their choice, including <a href="https://github.com/cloudfoundry/loggregator-release/blob/develop/docs/community-nozzles.md">community</a> and third-party nozzles.</li>
</ul>
<p>There are many third-party products you can choose from, including <a href="https://docs.pivotal.io/pcf-metrics/1-4/">PCF Metrics</a>.</p>
<h5 id="configure-settings-1">Configure Settings</h5>
<p>The following table describes the settings that you can apply to the exporter:</p>
<table class="table">
<thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>endpoint</td>
<td>the uri used to POST metrics</td>
<td>null</td>
</tr>
<tr>
<td>accessToken</td>
<td>the authentication token needed to access the endpoint</td>
<td>null</td>
</tr>
<tr>
<td>rateMilli</td>
<td>delay in milliseconds between metrics POSTs</td>
<td>60000</td>
</tr>
<tr>
<td>validateCertificates</td>
<td>validate SSL certificates received from exporter service</td>
<td>true</td>
</tr>
<tr>
<td>timeoutSeconds</td>
<td>timeout used in seconds for each POST request</td>
<td>3</td>
</tr>
<tr>
<td>applicationId</td>
<td>cloud foundry application ID the POST applies to</td>
<td>null</td>
</tr>
<tr>
<td>instanceId</td>
<td>cloud foundry application instance ID the POST applies to</td>
<td>null</td>
</tr>
<tr>
<td>instanceIndex</td>
<td>cloud foundry application instance index the POST applies to</td>
<td>null</td>
</tr>
<tr>
<td>micrometerMetricWriter</td>
<td>emit metrics using Spring Boot 2.x format</td>
<td>false</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: <strong>The <code>endpoint</code>, <code>accessToken</code>,<code>applicationId</code>, <code>instanceId</code> and <code>instanceIndex</code> settings above will be automatically picked up from the Metrics Forwarder service binding found for your application.</strong></p>
<h5 id="asp.net-core-app-1">ASP.NET Core App</h5>
<p>There are three steps needed to use the Metrics Forwarder for Pivotal Cloud Foundry (PCF) service:</p>
<ol>
<li>Create and bind a forwarder service to your application. Follow the steps in the Metrics Forwarder for PCF <a href="https://docs.pivotal.io/metrics-forwarder/using.html">documentation</a>.</li>
<li>Add the exporter to the service container. Use the <code>AddMetricsForwarderExporter()</code> extension method from <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.ExporterCore/Metrics/CloudFoundryForwarder/EndpointServiceCollectionExtensions.cs">EndpointServiceCollectionExtensions</a>.</li>
<li>Start the exporter background thread. Use the <code>UseMetricsExporter()</code> extension method from <a href="https://github.com/SteeltoeOSS/Management/blob/master/src/Steeltoe.Management.ExporterCore/Metrics/CloudFoundryForwarder/EndpointApplicationBuilderExtensions.cs">EndpointApplicationBuilderExtensions</a>.</li>
</ol>
<pre><code class="language-csharp">public class Startup
{
    public Startup(IConfiguration configuration)
    {
        Configuration = configuration;
    }
    public void ConfigureServices(IServiceCollection services)
    {
        // Add Metrics collection
        services.AddMetricsActuator(Configuration);

        // Export metrics to Cloud Foundry forwarder
        services.AddMetricsForwarderExporter(Configuration);
        ...
    }
    public void Configure(IApplicationBuilder app)
    {
        app.UseStaticFiles();

        // Expose Metrics endpoint
        app.UseMetricsActuator();

        app.UseMvc();

        // Start up metrics exporter
        app.UseMetricsExporter();
    }
}
</code></pre>
<h5 id="asp.net-4.x-app-1">ASP.NET 4.x App</h5>
<p>There are two steps needed to use the Metrics Forwarder for Pivotal Cloud Foundry (PCF) service:</p>
<ol>
<li>Create and bind a forwarder service to your application. Follow the steps in the Metrics Forwarder for PCF <a href="https://docs.pivotal.io/metrics-forwarder/using.html">documentation</a>.</li>
<li>Configure and start the exporter background thread.</li>
</ol>
<pre><code class="language-csharp">public class ManagementConfig
{
    public static IMetricsExporter MetricsExporter { get; set; }

    public static void UseCloudFoundryMetricsExporter(IConfiguration configuration, ILoggerFactory loggerFactory = null)
    {
        var options = new CloudFoundryForwarderOptions(configuration);
        MetricsExporter = new CloudFoundryForwarderExporter(
            options,
            OpenCensusStats.Instance,
            loggerFactory != null ? loggerFactory.CreateLogger&lt;CloudFoundryForwarderExporter&gt;() : null);
    }
    public static void Start()
    {
        DiagnosticsManager.Instance.Start();
        if (MetricsExporter != null)
        {
            MetricsExporter.Start();
        }
    }
    public static void Stop()
    {
        DiagnosticsManager.Instance.Stop();
        if (MetricsExporter != null)
        {
            MetricsExporter.Stop();
        }
    }
}
</code></pre>
