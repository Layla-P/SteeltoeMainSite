<h1 id="single-sign-on-with-oauth2">Single Sign-on with OAuth2</h1>
<p>Single Sign-on with OAuth 2.0 enables you to leverage existing credentials configured in a <a href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a href="https://docs.pivotal.io/p-identity">Pivotal Single Sign-on service</a> for authentication and authorization in ASP.NET Core applications. Single signon functionality for ASP.NET 4.x applications is available with the <a href="#2-0.single-sign-on-with-openid-connect">OpenID Connect provider</a>.</p>
<p>In addition to the Quick Start, you can use other Steeltoe sample applications to help you understand how to use this provider, including:</p>
<ul>
<li><a href="https://github.com/SteeltoeOSS/Samples/tree/master/FreddysBBQ">FreddysBBQ</a>: A polyglot microservices-based sample application showing interoperability between Java and .NET on Cloud Foundry, secured with OAuth2 Security Services, and using Spring Cloud Services.</li>
</ul>
<p>The source code for this provider can be found <a href="https://github.com/SteeltoeOSS/Security">here</a>.</p>
<h2 id="usage">Usage</h2>
<p>This package is built on the OAuth 2 authentication flow and the services provided by ASP.NET Core Security. You should take some time to understand both before proceeding to use this provider.</p>
<p>Many resources are available for understanding OAuth 2. For example, see <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">Introduction to OAuth 2</a> or <a href="https://www.bubblecode.net/en/2016/01/22/understanding-oauth2/">Understanding OAuth 2</a>.</p>
<p>To get a good understanding of ASP.NET Core Security, review the <a href="https://docs.microsoft.com/en-us/aspnet/core/security">documentation</a> provided by Microsoft. If you are upgrading an application from ASP.NET Core 1.x, you may also want to review <a href="https://docs.microsoft.com/en-us/aspnet/core/migration/1x-to-2x/identity-2x">Migrating Auth and Identity to ASP.NET Core 2.0</a>.</p>
<p>Additionally, you should know how the <a href="https://docs.asp.net/en/latest/fundamentals/configuration.html">.NET Configuration service</a> and the <code>ConfigurationBuilder</code> work and how to add providers to the builder.</p>
<p>You should also know how the ASP.NET Core <a href="https://docs.asp.net/en/latest/fundamentals/startup.html">Startup</a> class is used in configuring the application services and how the middleware used in the application. Pay particular attention to the usage of the <code>Configure()</code> and <code>ConfigureService())</code> methods.</p>
<p>With regard to Cloud Foundry, you should know how Cloud Foundry OAuth2 security services (for example, <a href="https://github.com/cloudfoundry/uaa">UAA Server</a> or <a href="https://docs.pivotal.io/p-identity/">Pivotal Single Signon</a>) work.</p>
<p>In order to use the security provider:</p>
<ol>
<li>Create an instance of a Cloud Foundry OAuth2 service and bind it to your application.</li>
<li>(Optional) Configure any additional settings the security provider needs.</li>
<li>Add the Cloud Foundry configuration provider to the <code>ConfigurationBuilder</code>.</li>
<li>Add and use the security provider in the application.</li>
<li>Secure your endpoints.</li>
</ol>
<h3 id="add-nuget-reference">Add NuGet Reference</h3>
<p>To use the provider, add a reference to the Steeltoe Cloud Foundry Security NuGet.</p>
<p>The provider can be found in the <code>Steeltoe.Security.Authentication.CloudFoundryCore</code> package.</p>
<p>You can add the provider to your project by using the following <code>PackageReference</code>:</p>
<pre><code class="language-xml">&lt;ItemGroup&gt;
...
    &lt;PackageReference Include=&quot;Steeltoe.Security.Authentication.CloudFoundryCore&quot; Version= &quot;2.1.0&quot;/&gt;
...
&lt;/ItemGroup&gt;
</code></pre>
<h3 id="configure-settings">Configure Settings</h3>
<p>Configuring settings for the provider beyond what is provided in a service binding is not typically required, but when Cloud Foundry is using self-signed certificates, you might need to disable certificate validation, as shown in the following example:</p>
<pre><code class="language-json">{
  &quot;security&quot;: {
    &quot;oauth2&quot;: {
      &quot;client&quot;: {
        &quot;validateCertificates&quot;: false
      }
    }
  }
}
</code></pre>
<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<p>The Steeltoe OAuth2 security provider options are based on <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.oauth.oauthoptions"><code>Microsoft.AspNetCore.Authentication.OAuth.OAuthOptions</code></a>, with these additional properties:</p>
<table class="table">
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>additionalScopes</td>
<td>Scopes to request for tokens in addition to <code>openid</code></td>
<td><code>string.Empty</code></td>
</tr>
<tr>
<td>validateCertificates</td>
<td>Validate Auth server certificate</td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: <strong>Each setting above must be prefixed with <code>security:oauth2:client</code></strong>.</p>
<h3 id="cloud-foundry">Cloud Foundry</h3>
<p>As mentioned earlier, there are two OAuth-compatible services available on Cloud Foundry. We recommend you read the offical documentation (<a href="https://github.com/cloudfoundry/uaa">UAA Server</a> and <a href="https://docs.pivotal.io/p-identity/1-5/getting-started.html">Pivotal SSO</a>) or follow the instructions included in the samples for <a href="https://github.com/SteeltoeOSS/Samples/blob/master/Security/src/AspDotNetCore/CloudFoundrySingleSignon/README.md">UAA Server</a> and <a href="https://github.com/SteeltoeOSS/Samples/blob/master/Security/src/AspDotNetCore/CloudFoundrySingleSignon/README-SSO.md">Pivotal SSO</a> to quickly learn how to create and bind OAuth2 services.</p>
<p>Regardless of which provider you choose, once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<h3 id="add-cloud-foundry-oauth">Add Cloud Foundry OAuth</h3>
<p>As with other ASP.NET Core middleware, in order to configure the Cloud Foundry OAuth provider in your application,
first add and configure it in the <code>ConfigureServices()</code> method of the <code>Startup</code> class, then use it in the <code>Configure()</code>
method of the <code>Startup</code> class. The Cloud Foundry OAuth provider is built on top of ASP.NET Core Authentication services
and is configured with an extension method on the <code>AuthenticationBuilder</code>, as seen in the following example:</p>
<pre><code class="language-csharp">using Steeltoe.Security.Authentication.CloudFoundry;

public class Startup {
    ...
    public IConfiguration Configuration { get; private set; }
    public Startup(IConfiguration configuration)
    {
        Configuration = configuration;
    }
    public void ConfigureServices(IServiceCollection services)
    {
        ...
        services.AddAuthentication(options =&gt;
            {
                options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
                options.DefaultChallengeScheme = CloudFoundryDefaults.AuthenticationScheme;
            })
            .AddCookie((options) =&gt;
            {
                // set values like login url, access denied path, etc here
                options.AccessDeniedPath = new PathString(&quot;/Home/AccessDenied&quot;);
            })
            .AddCloudFoundryOAuth(Configuration); // Add Cloud Foundry authentication service
        ...
    }
    public void Configure(IApplicationBuilder app, ...)
    {
        ...
        // Use the protocol from the original request when generating redirect uris
        // (eg: when TLS termination is handled by an appliance in front of the app)
        app.UseForwardedHeaders(new ForwardedHeadersOptions
        {
            ForwardedHeaders = ForwardedHeaders.XForwardedProto
        });

        // Add authentication middleware to pipeline
        app.UseAuthentication();
    }
    ...
</code></pre>
<p>The <code>AddCloudFoundryOAuth(Configuration)</code> method call configures and adds the Cloud Foundry OAuth authentication service to the service container. Once in place, it can be used by the authentication middleware during request processing.</p>
<blockquote class="blockquote">
<p>NOTE: When running behind a reverse-proxy (like Gorouter or HAProxy) that handles TLS termination for your app, use <code>app.UseForwardedHeaders</code> to generate the correct redirect URI so that the user is not sent back over HTTP instead of HTTPS after authenticating.</p>
</blockquote>
<h3 id="securing-endpoints">Securing Endpoints</h3>
<p>Once the <code>Startup</code> class has been updated, you can secure endpoints with the standard ASP.NET Core <code>Authorize</code> attribute, as shown in the following example:</p>
<pre><code class="language-csharp">using Microsoft.AspNetCore.Authentication;
...
public class HomeController : Controller
{
    public IActionResult Index()
    {
        return View();
    }

    [Authorize]
    public IActionResult About()
    {
        ViewData[&quot;Message&quot;] = &quot;Your About page.&quot;;
        return View();
    }

    [Authorize(Policy = &quot;testgroup1&quot;)]
    public IActionResult Contact()
    {
        ViewData[&quot;Message&quot;] = &quot;Your contact page.&quot;;

        return View();
    }
    ...
}
</code></pre>
<p>The preceding example code establishes the following security rules:</p>
<ul>
<li>If a user attempts to access the <code>About</code> action and the user is not authenticated, then the user is redirected to the OAuth2 server (such as a UAA Server) to login.</li>
<li>If an authenticated user attempts to access the <code>Contact</code> action but does not meet the restrictions established by the policy <code>testgroup1</code>, the user is denied access.</li>
</ul>
<blockquote class="blockquote">
<p>TIP: See the Microsoft documentation on <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authorization/introduction">ASP.NET Core Authorization</a>.</p>
</blockquote>
