<h1 id="redis-key-storage-provider">Redis Key Storage Provider</h1>
<p><span style="display:inline-block;margin:0 20px;">For use with </span><span style="display:inline-block;vertical-align:top;width:40%"> <img src="/images/CFF_Logo_rgb.png" class="img-fluid" alt="alt text" title="Cloud Foundry" /></span></p>
<p>By default, ASP.NET Core stores the key ring on the local file system. Local file system usage in a Cloud Foundry environment is unworkable and violates the <a href="https://12factor.net/">twelve-factor guidelines</a> for developing cloud native applications. By using the Steeltoe Redis Key Storage provider, you can reconfigure the Data Protection service to use Redis on Cloud Foundry for storage.</p>
<h2 id="usage">Usage</h2>
<p>To use this provider:</p>
<ol>
<li>Create a Redis Service instance and bind it to your application.</li>
<li>Add the Steeltoe Cloud Foundry config provider to your <code>ConfigurationBuilder</code>.</li>
<li>Add the Redis <code>ConnectionMultiplexer</code> to your ServiceCollection.</li>
<li>Add <code>DataProtection</code> to your <code>ServiceCollection</code> and configure it to <code>PersistKeysToRedis</code>.</li>
</ol>
<h3 id="add-nuget-reference">Add NuGet Reference</h3>
<p>To use the provider, add a reference to the Steeltoe DataProtection Redis NuGet.</p>
<p>The provider can be found in the <code>Steeltoe.Security.DataProtection.RedisCore</code> package.</p>
<p>You can add the provider to your project by using the following <code>PackageReference</code> in your project file:</p>
<pre><code class="language-xml">&lt;ItemGroup&gt;
...
    &lt;PackageReference Include=&quot;Steeltoe.Security.DataProtection.RedisCore&quot; Version= &quot;2.1.0&quot;/&gt;
...
&lt;/ItemGroup&gt;
</code></pre>
<p>You also need the Steeltoe Redis connector. Add the <code>Steeltoe.CloudFoundry.ConnectorCore</code> package to get the Redis connector and helpers for setting it up.</p>
<p>You can use the NuGet Package Manager tools or directly add the following package reference to your .csproj file:</p>
<pre><code class="language-xml">&lt;ItemGroup&gt;
...
    &lt;PackageReference Include=&quot;Steeltoe.CloudFoundry.ConnectorCore&quot; Version= &quot;2.1.0&quot;/&gt;
...
&lt;/ItemGroup&gt;
</code></pre>
<h3 id="cloud-foundry">Cloud Foundry</h3>
<p>To use the Redis Data Protection key ring provider on Cloud Foundry, you have to install a Redis service and create and bind an instance of it to your application by using the Cloud Foundry command line, as shown in the following example:</p>
<pre><code class="language-bash"># Create Redis service
cf create-service p-redis shared-vm myRedisCache

# Bind service to `myApp`
cf bind-service myApp myRedisCache

# Restage the app to pick up change
cf restage myApp
</code></pre>
<blockquote class="blockquote">
<p>NOTE: The preceding commands are for the Redis service provided by Pivotal on Cloud Foundry. If you use a different service, you have to adjust the <code>create-service</code> command.</p>
</blockquote>
<p>Once the service is bound to your application, the settings are available in <code>VCAP_SERVICES</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<h3 id="add-redis-iconnectionmultiplexer">Add Redis IConnectionMultiplexer</h3>
<p>The next step is to add the StackExchange Redis <code>IConnectionMultiplexer</code> to your service container.</p>
<p>You can do so in the <code>ConfigureServices()</code> method of the <code>Startup</code> class by using the Steeltoe Redis Connector, as follows:</p>
<pre><code class="language-csharp">using Steeltoe.CloudFoundry.Connector.Redis;

public class Startup {
    ...
    public IConfiguration Configuration { get; private set; }
    public Startup(IConfiguration configuration)
    {
        Configuration = configuration;
    }
    public void ConfigureServices(IServiceCollection services)
    {
        // Add StackExchange ConnectionMultiplexer configured from Cloud Foundry
        services.AddRedisConnectionMultiplexer(Configuration);

        // Add framework services.
        services.AddMvc();
        ...
    }
    ...
</code></pre>
<p>See the documentation on the <a href="../steeltoe-connectors/#5-2-2-configure-settings">Steeltoe Redis connector</a> for details on how you can configure additional settings to control its behavior.</p>
<h3 id="add-persistkeystoredis">Add PersistKeysToRedis</h3>
<p>The last step is to use the provider to configure DataProtection to persist keys to Redis.</p>
<p>You can do so in the <code>ConfigureServices()</code> method of the <code>Startup</code> class, as shown in the following example:</p>
<pre><code class="language-csharp">using Steeltoe.CloudFoundry.Connector.Redis;

public class Startup {
    ...
    public IConfiguration Configuration { get; private set; }
    public Startup(IConfiguration configuration)
    {
        Configuration = configuration;
    }
    public void ConfigureServices(IServiceCollection services)
    {
        // Add StackExchange ConnectionMultiplexer configured from Cloud Foundry
        services.AddRedisConnectionMultiplexer(Configuration);

        // Add DataProtection and persist keys to Cloud Foundry Redis service
        services.AddDataProtection()
            .PersistKeysToRedis()
            .SetApplicationName(&quot;Some Name&quot;);

        // Add framework services.
        services.AddMvc();
        ...
    }
    ...
</code></pre>
<h3 id="use-redis-key-store">Use Redis Key Store</h3>
<p>Once the Redis Key Store has been set up, the keys used by the <code>DataProtection</code> framework are stored in the bound Redis Cloud Foundry service. You need not do more.</p>
