<h1 id="credhub-api-client">CredHub API Client</h1>
<p><a href="https://github.com/cloudfoundry-incubator/credhub">CredHub</a> manages credentials such as  passwords, certificates, certificate authorities, ssh keys, rsa keys, and other arbitrary values. Steeltoe provides the <code>CredHubBase</code> library for interacting with the <a href="https://credhub-api.cfapps.io/">CredHub API</a> and provides the <code>CredHubCore</code> library for making that client library simpler to use in ASP.NET Core applications. Cloud Foundry is not required for the CredHub server or client but is used in this documentation as the hosting environment. You may wish to review the documentation for <a href="https://docs.pivotal.io/pivotalcf/2-0/credhub/">CredHub on PCF</a>. If you do not already have a UAA user to use for this test, you will need to use the UAA command line tool to establish some security credentials for the sample app. Choose one of the provided <code>credhub-setup</code> scripts in the folder <code>samples/Security/scripts</code> to target your Cloud Foundry environment and create a UAA client with permissions to read and write in CredHub.</p>
<blockquote class="blockquote">
<p>NOTE: If you choose to change the values for <code>UAA_CLIENT_ID</code> or <code>UAA_CLIENT_SECRET</code>, be sure to update the credentials in appsettings.json</p>
</blockquote>
<!--  -->
<blockquote class="blockquote">
<p>WARNING: As of this writing, CredHub is not approved for general use in all applications. We encourage you to check whether your use case is currently supported by CredHub before getting too involved.</p>
</blockquote>
<h2 id="usage">Usage</h2>
<p>To use the Steeltoe CredHub Client, you must:</p>
<ul>
<li>Have access to a CredHub Server (the client was built against version 1.6.5).</li>
<li>Have UAA credentials for accessing the server with sufficient permissions for your use case</li>
<li>Use the provided methods and constructors to create, inject, or utilize the client.</li>
</ul>
<h3 id="add-nuget-reference">Add NuGet Reference</h3>
<p>To use this library with ASP.NET Core, add a NuGet reference to <code>Steeltoe.Security.DataProtection.CredHubCore</code>. For other application types, use <code>Steeltoe.Security.DataProtection.CredHubBase</code>. Most of the functionality resides in <code>CredHubBase</code>. The purpose of <code>CredHubCore</code> is to provide additional methods for a simpler experience when using ASP.NET Core.</p>
<p>Use the NuGet package manager tools or directly add the appropriate package to your project using the a <code>PackageReference</code>, as follows:</p>
<pre><code class="language-xml">&lt;ItemGroup&gt;
...
    &lt;PackageReference Include=&quot;Steeltoe.Security.DataProtection.CredHubCore&quot; Version= &quot;2.1.0-rc1&quot;/&gt;
...
&lt;/ItemGroup&gt;
</code></pre>
<h3 id="configure-settings">Configure Settings</h3>
<p>Settings for this library are expected to have a prefix of <code>CredHubClient</code>. The following example shows what that looks like in JSON:</p>
<pre><code class="language-json">{
  ...
  &quot;credHubClient&quot;: {
    &quot;validateCertificates&quot;: &quot;false&quot;
  }
  ...
}
</code></pre>
<p>The <code>CredHubClient</code> supports four settings:</p>
<table class="table">
<thead>
<tr>
<th>Setting Name</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>CredHubUrl</td>
<td>The address of the CredHub API</td>
<td><a href="https://credhub.service.cf.internal:8844/api">https://credhub.service.cf.internal:8844/api</a></td>
</tr>
<tr>
<td>CredHubUser</td>
<td>The username for UAA auth</td>
<td><code>null</code></td>
</tr>
<tr>
<td>CredHubPassword</td>
<td>The password for UAA auth</td>
<td><code>null</code></td>
</tr>
<tr>
<td>ValidateCertificates</td>
<td>Whether to validate certificates for UAA and/or CredHub servers</td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
<p>The samples and most templates are already set up to read from <code>appsettings.json</code>. See <a href="#reading-configuration-values">Reading Configuration Values</a>.</p>
<h3 id="on-cloud-foundry">On Cloud Foundry</h3>
<p>Pivotal Cloud Foundry (in versions 2.0 and up) ships with a version of CredHub Server with which this client works. To use UAA authentication, you will need a user with <code>credhub.read</code> and/or <code>credhub.write</code> claims.</p>
<h3 id="getting-a-client">Getting a Client</h3>
<p>There are several ways to create a <code>CredHubClient</code>, depending on whether you want to use Microsoft's dependency injection. Regardless of the creation method selected, once the client has been created, all functionality is the same.</p>
<h4 id="create-and-inject-client">Create and Inject Client</h4>
<p>If you use Microsoft's Dependency injection framework, you can use <code>IServiceCollection.AddCredHubClient()</code> to create, configure, and inject <code>CredHubClient</code>, as shown in the folloowing example:</p>
<pre><code class="language-csharp">using Steeltoe.Security.DataProtection.CredHubCore;
...
public class Startup
{
    ILoggerFactory logFactory;
    public Startup(IConfiguration configuration, ILoggerFactory logFactory)
    {
        Configuration = configuration;
        this.logFactory = logFactory;
    }
    public IConfiguration Configuration { get; }
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddMvc();
        services.AddCredHubClient(Configuration, logFactory);
    }
    ...
}
...
</code></pre>
<h4 id="create-uaa-client">Create UAA Client</h4>
<p>You can use <code>CredHubClient.CreateUAAClientAsync()</code> to directly create a CredHub client that authenticates with a username and password that is valid on the UAA server CredHub is configured to trust. This client calls <code>/info</code> on the CredHub server to discover the UAA server's address and appends <code>/oauth/token</code> when requesting a token. The following listing shows how to do it:</p>
<pre><code class="language-csharp">var credHubClient = await CredHubClient.CreateUAAClientAsync(new CredHubOptions());
</code></pre>
<blockquote class="blockquote">
<p>NOTE: If you need to override the UAA server address, use the <code>UAA_Server_Override</code> environment variable, making sure to include the path to the token endpoint.</p>
</blockquote>
<h4 id="interpolation-only">Interpolation-Only</h4>
<p>If you wish to use CredHub to interpolate entries in <code>VCAP_SERVICES</code>, you can use <code>WebHostBuilder.UseCredHubInterpolation()</code>. This method looks for <code>credhub-ref</code> in <code>VCAP_SERVICES</code> and uses a <code>CredHubClient</code> to replace the credential references with credentials stored in CredHub but does not return the <code>CredHubClient</code>. The following example shows how to do it:</p>
<pre><code class="language-csharp">    var host = new WebHostBuilder()
        .UseKestrel()
        .UseCloudFoundryHosting()
        .UseContentRoot(Directory.GetCurrentDirectory())
        .UseIISIntegration()
        .UseStartup&lt;Startup&gt;()
        .ConfigureAppConfiguration((builderContext, config) =&gt;
        {
            config.SetBasePath(builderContext.HostingEnvironment.ContentRootPath)
                .AddJsonFile(&quot;appsettings.json&quot;, optional: false, reloadOnChange: true)
                .AddJsonFile($&quot;appsettings.{builderContext.HostingEnvironment.EnvironmentName}.json&quot;, optional: true)
                .AddCloudFoundry()
                .AddEnvironmentVariables();
        })
        .ConfigureLogging((builderContext, loggingBuilder) =&gt;
        {
            loggingBuilder.AddConfiguration(builderContext.Configuration.GetSection(&quot;Logging&quot;));
            loggingBuilder.AddDynamicConsole();
        })
        .UseCredHubInterpolation(new LoggerFactory().AddConsole())
        .Build();
</code></pre>
<h3 id="credential-types">Credential Types</h3>
<p>These are the .NET representations of credentials that can be stored in CredHub. Refer to the <a href="https://credhub-api.cfapps.io/">CredHub documentation</a> for more detail.</p>
<h4 id="valuecredential">ValueCredential</h4>
<p>Any string can be used for a <code>ValueCredential</code>. CredHub allows Get, Set, Delete, and Find operations with <code>ValueCredential</code></p>
<h4 id="passwordcredential">PasswordCredential</h4>
<p>Any string can be used for a <code>PasswordCredential</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>PasswordCredential</code></p>
<h4 id="usercredential">UserCredential</h4>
<p>A <code>UserCredential</code> has <code>string</code> properties for <code>Username</code> and <code>Password</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>UserCredential</code>. Regenerate operations do not regenerate the username.</p>
<h4 id="jsoncredential">JsonCredential</h4>
<p>Any JSON object can be used for a <code>JsonCredential</code>. CredHub allows Get, Set, Delete, and Find operations with <code>JsonCredential</code>.</p>
<h4 id="certificatecredential">CertificateCredential</h4>
<p>A <code>CertificateCredential</code> represents a security certificate. CredHub allows Get, Set, Delete, Find, Generate, Regenerate, and Bulk Regenerate operations with <code>CertificateCredential</code>. The following table describes specific properties:</p>
<table class="table">
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CertificateAuthority</td>
<td>The certificate of the Certificate Authority</td>
</tr>
<tr>
<td>CertificateAuthorityName</td>
<td>The name of the CA credential in credhub that has signed this certificate</td>
</tr>
<tr>
<td>Certificate</td>
<td>The string representation of the certificate</td>
</tr>
<tr>
<td>PrivateKey</td>
<td>The private key for the certificate</td>
</tr>
</tbody>
</table>
<h4 id="rsacredential">RsaCredential</h4>
<p>The <code>RsaCredential</code> has string properties for <code>PublicKey</code> and <code>PrivateKey</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>RsaCredential</code>.</p>
<h4 id="sshcredential">SshCredential</h4>
<p>The <code>SshCredential</code> has string properties for <code>PublicKey</code>, <code>PrivateKey</code>, and <code>PublicKeyFingerprint</code>. CredHub allows Get, Set, Delete, Find, Generate, and Regenerate operations with <code>SshCredential</code>.</p>
<h3 id="credhub-read-operations">CredHub Read Operations</h3>
<p>All <code>CredHubClient</code> Read operations operate asynchronously and do not change the credentials or permissions stored in CredHub. Refer to the <a href="https://credhub-api.cfapps.io/">CredHub documentation</a> for more detail. For brevity, the samples shown later in this guide use <code>_credHubClient</code> to reference an instance of <code>CredHubClient</code> that has been created previously. See <a href="#4-2-4-getting-a-client">Getting a Client</a> for instructions on how to create a <code>CredHubClient</code>.</p>
<h4 id="get-by-id">Get by ID</h4>
<p>You can use <code>await _credHubClient.GetByIdAsync&lt;CredentialType&gt;(credentialId)</code> to retrieve a credential by its <code>Guid</code>. Only the current credential value is returned.</p>
<h4 id="get-by-name">Get by Name</h4>
<p>You can use <code>await _credHubClient.GetByNameAsync&lt;CredentialType&gt;(credentialName)</code> to retrieve a credential by its <code>Name</code>. Only the current credential value is returned.</p>
<h4 id="get-by-name-with-history">Get by Name with History</h4>
<p>You can use <code>await _credHubClient.GetByNameWithHistoryAsync&lt;CredentialType&gt;(credentialName, numEntries)</code> to retrieve a credential by name with the most recent <code>numEntries</code> holding the number of entries.</p>
<h4 id="find-by-name">Find by Name</h4>
<p>You can use <code>await _credHubClient.FindByNameAsync(credentialName)</code> to retrieve a list of <code>FoundCredential</code> objects that are either a full or partial match for the name searched. The <code>FoundCredential</code> type includes only the <code>Name</code> and <code>VersionCreatedAt</code> properties, so follow-up requests are expected to retrieve credential details.</p>
<h4 id="find-by-path">Find by Path</h4>
<p>You can use <code>await _credHubClient.FindByPathAsync(path)</code> to retrieve a list of <code>FoundCredential</code> objects that are either a full or partial match for the name searched. The <code>FoundCredential</code> type includes only the <code>Name</code> and <code>VersionCreatedAt</code> properties, so follow-up requests are expected to retrieve credential details. Use the <code>/</code> path value to return all accessible credentials.</p>
<h4 id="find-all-paths">Find All Paths</h4>
<p>You can use <code>await _credHub.FindAllPathsAsync()</code> to retrieve a list of all known credential paths.</p>
<h4 id="interpolate">Interpolate</h4>
<p>One of the more powerful features of CredHub is the <code>Interpolate</code> endpoint. With one request, you may retrieve N number of credentials that have been stored in CredHub. To use it from .NET, call <code>await _credHub.InterpolateServiceDataAsync(serviceData)</code>, where <code>serviceData</code> is the string representation of <code>VCAP_SERVICES</code>. <code>CredHubClient</code> returns the interpolated <code>VCAP_SERVICES</code> data as a string. If you wish to have the interpolated data applied to your application configuration, see <a href="#4-2-4-4-interpolation-only">the .UseCredHubInterpolation() documentation</a></p>
<p>The following example shows a typical request object for the <code>Interpolate</code> endpoint:</p>
<pre><code class="language-json">{
  &quot;p-demo-resource&quot;: [
    {
      &quot;credentials&quot;: {
        &quot;credhub-ref&quot;: &quot;((/config-server/credentials))&quot;
      },
      &quot;label&quot;: &quot;p-config-server&quot;,
      &quot;name&quot;: &quot;config-server&quot;,
      &quot;plan&quot;: &quot;standard&quot;,
      &quot;provider&quot;: null,
      &quot;syslog_drain_url&quot;: null,
      &quot;tags&quot;: [
        &quot;configuration&quot;,
        &quot;spring-cloud&quot;
      ],
      &quot;volume_mounts&quot;: []
    }
  ]
}
</code></pre>
<p>The following example shows a typical response object from the <code>Interpolate</code> endpoint:</p>
<pre><code class="language-json">{
  &quot;p-demo-resource&quot;: [
    {
      &quot;credentials&quot;: {
        &quot;key&quot;: 123,
        &quot;key_list&quot;: [
          &quot;val1&quot;,
          &quot;val2&quot;
        ],
        &quot;is_true&quot;: true
      },
      &quot;label&quot;: &quot;p-config-server&quot;,
      &quot;name&quot;: &quot;config-server&quot;,
      &quot;plan&quot;: &quot;standard&quot;,
      &quot;provider&quot;: null,
      &quot;syslog_drain_url&quot;: null,
      &quot;tags&quot;: [
        &quot;configuration&quot;,
        &quot;spring-cloud&quot;
      ],
      &quot;volume_mounts&quot;: []
    }
  ]
}
</code></pre>
<blockquote class="blockquote">
<p>NOTE: At this time, only credential references at <code>credentials.credhub-ref</code> are interpolated. The <code>credhub-ref</code> key is removed and the referenced credential object is set as the value of the credentials.</p>
</blockquote>
<h3 id="credhub-change-operations">CredHub Change Operations</h3>
<p>All <code>CredHubClient</code> Change operations operate asynchronously and affect stored credentials. Refer to the <a href="https://credhub-api.cfapps.io/">CredHub documentation</a> for more detail. For brevity, the samples shown later in this guide use <code>_credHubClient</code> to reference an instance of <code>CredHubClient</code> that has been created previously. See <a href="#4-2-4-getting-a-client">Getting a Client</a> for instructions on how to create a <code>CredHubClient</code>.</p>
<h4 id="write">Write</h4>
<p>If you already have a credential that you want to store in CredHub, use a <code>Write</code> request. <code>CredHubClient.WriteAsync&lt;T&gt;()</code> expects a request object that descends from <code>CredentialSetRequest</code>. There is a <code>[Type]SetRequest</code> class for each credential type (<code>ValueSetRequest</code>, <code>PasswordSetRequest</code>, and so on). The SetRequest family of classes includes optional parameters for overwriting existing values and setting permissions, in addition to value properties for the credential. Include the type of credential you want to write to CredHub in the T parameter so the compiler knows the return type. The following example shows a typical <code>Write</code> request:</p>
<pre><code class="language-csharp">var setValueRequest = new ValueSetRequest(&quot;sampleValueCredential&quot;, &quot;someValue&quot;);
// set the value of credential &quot;/sampleValueCredential&quot; to &quot;someValue&quot; if there is NOT an existing value
var setValue1 = await _credHub.WriteAsync&lt;ValueCredential&gt;(setValueRequest);

// set the value of credential &quot;/sampleValueCredential&quot; to &quot;someValue&quot; even if there is an existing value
setValueRequest.Overwrite = true;
var setValue2 = await _credHub.WriteAsync&lt;ValueCredential&gt;(setValueRequest);
</code></pre>
<blockquote class="blockquote">
<p>NOTE: The default behavior on <code>Write</code> requests is to leave existing values alone. If you wish to overwrite a credential, be sure to pass either <code>OverwriteMode.converge</code> or <code>OverwriteMode.overwrite</code> for the <code>overwriteMode</code> parameter on your request object. See <a href="https://credhub-api.cfapps.io/#overwriting-credential-values">Overwriting Credential Values</a>.</p>
</blockquote>
<p>Write requests allow the setting of permissions on a credential during generation, as shown in the following example:</p>
<pre><code class="language-csharp">var desiredOperations = new List&lt;OperationPermissions&gt;
                        {
                            OperationPermissions.read,
                            OperationPermissions.write,
                            OperationPermissions.delete
                        };
var newPerms = new CredentialPermission { Actor = &quot;uaa-user:credhub_client&quot;, Operations = desiredOperations };
var setRequest = new ValueSetRequest(&quot;sampleValueCredential&quot;, &quot;someValue&quot;, new List&lt;CredentialPermission&gt; { newPerms });
var setValue = await _credHub.WriteAsync&lt;ValueCredential&gt;(setRequest);
</code></pre>
<h4 id="generate">Generate</h4>
<p>You can generate a new credential or overwrite an existing credential with a new generated value. CredHub is able to generate values for the following types: <code>CertificateCredential</code>, <code>PasswordCredential</code>, <code>RsaCredential</code>, <code>SshCredential</code>, and <code>UserCredential</code>. <code>CredHubClient.GenerateAsync&lt;T&gt;()</code> expects a request object that descends from <code>CredHubGenerateRequest</code>. There is a <code>[Type]GenerateRequest</code> class for each supported credential type (<code>CertificateGenerationRequest</code>, <code>PasswordGenerationRequest</code>, <code>RsaGenerationRequest</code>, and so on). Most of the <code>GenerateRequest</code> family of classes include a <code>[Type]GenerationParameters</code> parameter for specifying criteria for generating the credential. The following example shows how to generate a credential:</p>
<pre><code class="language-csharp">var genParameters = new PasswordGenerationParameters { Length = 20 };
var genRequest = new PasswordGenerationRequest(&quot;generatedPassword&quot;, genParameters);
CredHubCredential&lt;PasswordCredential&gt; genPassword = await _credHub.GenerateAsync&lt;PasswordCredential&gt;(genRequest);
</code></pre>
<p>The following example demonstrates that <code>Generate</code> requests allow the setting of permissions on a credential during generation:</p>
<pre><code class="language-csharp">var genParams = new PasswordGenerationParameters { Length = 20 };
var desiredOperations = new List&lt;OperationPermissions&gt;
                        {
                            OperationPermissions.read,
                            OperationPermissions.write,
                            OperationPermissions.delete
                        };
var newPerms = new CredentialPermission { Actor = &quot;uaa-user:credhub_client&quot;, Operations = desiredOperations };
var genRequest = new PasswordGenerationRequest(&quot;generatedPW&quot;, genParams, new List&lt;CredentialPermission&gt; { newPerms });
CredHubCredential&lt;PasswordCredential&gt; genPassword = await _credHub.GenerateAsync&lt;PasswordCredential&gt;(genRequest);
</code></pre>
<blockquote class="blockquote">
<p>NOTE: The default behavior on <code>Generate</code> requests is to leave existing values alone. If you wish to overwrite a credential, be sure to pass either <code>OverwriteMode.converge</code> or <code>OverwriteMode.overwrite</code> for the <code>overwriteMode</code> parameter on your request object. See <a href="https://credhub-api.cfapps.io/#overwriting-credential-values">Overwriting Credential Values</a>.</p>
</blockquote>
<h4 id="regenerate">Regenerate</h4>
<p>You can regenerate a credential in CredHub. CredHub can generate values for the following types: <code>CertificateCredential</code>, <code>PasswordCredential</code>, <code>RsaCredential</code>, <code>SshCredential</code>, and <code>UserCredential</code>.</p>
<blockquote class="blockquote">
<p>NOTE: Only credentials that were previously generated by CredHub can be regenerated.</p>
</blockquote>
<p>The following example shows one way to regenerate a credential:</p>
<pre><code class="language-csharp">var regeneratedCert = await _credHub.RegenerateAsync&lt;CertificateCredential&gt;(&quot;/MyGeneratedCert&quot;);
</code></pre>
<h4 id="bulk-regenerate">Bulk Regenerate</h4>
<p>You can regenerate all certificates that were previously generated by CredHub with a given certificate authority. The following example returns a list of <code>RegeneratedCertificates</code> which contains the credential names as a <code>List&lt;string&gt;</code> property named RegeneratedCredentials:</p>
<pre><code class="language-csharp">RegeneratedCertificates bulkRegenerate = await _credHub.BulkRegenerateAsync(&quot;NameThatCA&quot;);
</code></pre>
<h4 id="delete-by-name">Delete by Name</h4>
<p>You can delete a credential by its full name. The following example returns a boolean indicating success or failure:</p>
<pre><code class="language-csharp">bool deleteCertificate = await _credHub.DeleteByNameAsync(&quot;/MyPreviouslyGeneratedCertificate&quot;);
</code></pre>
<h3 id="permission-operations">Permission Operations</h3>
<p>CredHub supports permissions management on credential access for UAA users. See the <a href="https://credhub-api.cfapps.io/#permissions">offical CredHub Permissions documentation</a>.</p>
<h4 id="get-permissions">Get Permissions</h4>
<p>You can get the permissions associated with a credential, as shown in the following example:</p>
<pre><code class="language-csharp">List&lt;CredentialPermission&gt; response = await _credHub.GetPermissionsAsync(&quot;/example-password&quot;);
</code></pre>
<h4 id="add-permissions">Add Permissions</h4>
<p>You can add permissions to an existing credential. The following example eturns the updated list of permissions for the specified credential:</p>
<pre><code class="language-csharp">var desiredOps = new List&lt;OperationPermissions&gt; { OperationPermissions.read, OperationPermissions.write };
var newActorPermissions = new CredentialPermission { Actor = &quot;uaa-user:credhub_client&quot;, Operations = desiredOps };
var newPerms = new List&lt;CredentialPermission&gt; { newActorPermissions };
List&lt;CredentialPermission&gt; response = await _credHub.AddPermissionsAsync(&quot;/example-password&quot;, newPerms);
</code></pre>
<h4 id="delete-permissions">Delete Permissions</h4>
<p>You can delete a permission associated with a credential. The following example returns a boolean indicating success or failure:</p>
<pre><code class="language-csharp">bool response = await _credHub.DeletePermissionAsync(&quot;/example-password&quot;, &quot;uaa-user:credhub_client&quot;);
</code></pre>
