<h1 id="hashicorp-consul">HashiCorp Consul</h1>
<p>The Consul client implementation lets applications register services with a Consul server and discover services registered by other applications. This Steeltoe client utilizes the Consul .NET package provided by the open source project <a href="https://github.com/PlayFab/consuldotnet">consuldotnet</a>.</p>
<p>The Consul client implementation supports the following .NET application types:</p>
<ul>
<li>ASP.NET (MVC, WebForm, WebAPI, WCF)</li>
<li>ASP.NET Core</li>
<li>Console apps (.NET Framework and .NET Core)</li>
</ul>
<p>The source code for discovery can be found <a href="https://github.com/SteeltoeOSS/Discovery">here</a>.</p>
<h2 id="usage">Usage</h2>
<p>The following sections describe how to use the Consul client.</p>
<ul>
<li><a href="#3-2-1-consul-settings">Consul Settings</a></li>
<li><a href="#3-2-2-enable-logging">Enable Logging</a></li>
<li><a href="#3-2-3-health-contributors">Health Contributor</a></li>
<li><a href="#3-2-4-configuring-health-check">Configuring Health Check</a></li>
<li><a href="#3-2-5-configuring-metadata">Configuring Metadata</a></li>
<li><a href="#3-2-6-configuring-instanceid">Configuring InstanceId</a></li>
</ul>
<p>You should know how the new .NET <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration">Configuration service</a> works before starting to use the client. A basic understanding of the <code>ConfigurationBuilder</code> and how to add providers to the builder is necessary in order to configure the client.</p>
<p>You should also know how the ASP.NET Core <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/startup">Startup</a> class is used in configuring the application services and the middleware used in the app. Pay particular attention to the usage of the <code>Configure()</code> and <code>ConfigureServices()</code> methods.</p>
<p>It might be helpful to have an understanding of the <a href="https://spring.io/projects/spring-cloud-consul">Spring Cloud Consul</a> project as we have based our work on this project.</p>
<p>In order to use the Steeltoe Discovery client, you need to do the following:</p>
<ul>
<li>Add appropriate NuGet package reference to your project.</li>
<li>Configure the settings the Discovery client will use to register services in the service registry.</li>
<li>Configure the settings the Discovery client will use to discover services in the service registry.</li>
<li>Add and Use the Discovery client service in the application.</li>
<li>Use an injected <code>IDiscoveryClient</code> to lookup services.</li>
</ul>
<blockquote class="blockquote">
<p>NOTE: Most of the example code in the following sections is based on using Discovery in a ASP.NET Core application. If you are developing a ASP.NET 4.x application or a console-based app, see the <a href="https://github.com/SteeltoeOSS/Samples/tree/master/Discovery">other samples</a> for example code you can use.</p>
</blockquote>
<h3 id="consul-settings">Consul Settings</h3>
<p>To get the Steeltoe Discovery client to properly communicate with the Consul server, you need to provide a few configuration settings to the client. There are two sections you may need to configure.</p>
<p>The first pertains to configuring the information needed to connect to the Consul server. All of these settings should start with <code>consul:</code></p>
<table class="table">
<thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>Address of the Consul server</td>
<td>localhost</td>
</tr>
<tr>
<td>port</td>
<td>Port number the Consul server is listening on</td>
<td>8500</td>
</tr>
<tr>
<td>scheme</td>
<td>Scheme to use with the Consul server (http or https)</td>
<td>http</td>
</tr>
<tr>
<td>datacenter</td>
<td>The datacenter name passed in each request to the server</td>
<td>none</td>
</tr>
<tr>
<td>token</td>
<td>The auth token passed in each request to the server</td>
<td>true</td>
</tr>
<tr>
<td>waitTime</td>
<td>The time a Watch request blocks or waits</td>
<td>none</td>
</tr>
<tr>
<td>username</td>
<td>Username for HTTP authentication</td>
<td>none</td>
</tr>
<tr>
<td>password</td>
<td>Password for HTTP authentication</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>The second set of settings you may need to specify pertain to service registration and service discovery. All of these settings should start with <code>consul:discovery</code></p>
<table class="table">
<thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>enabled</td>
<td>Enable to disable the Consul client</td>
<td>true</td>
</tr>
<tr>
<td>register</td>
<td>Whether to register as a service</td>
<td>true</td>
</tr>
<tr>
<td>deregister</td>
<td>Whether to de-register on shutdown</td>
<td>true</td>
</tr>
<tr>
<td>serviceName</td>
<td>The service name to register</td>
<td>computed</td>
</tr>
<tr>
<td>scheme</td>
<td>Scheme to register for service</td>
<td>http</td>
</tr>
<tr>
<td>hostname</td>
<td>Hostname to use when registering server</td>
<td>computed</td>
</tr>
<tr>
<td>ipAddress</td>
<td>IP address to register</td>
<td>computed</td>
</tr>
<tr>
<td>port</td>
<td>Port number to register</td>
<td>none</td>
</tr>
<tr>
<td>preferIpAddress</td>
<td>Register IP address instead of hostname</td>
<td>false</td>
</tr>
<tr>
<td>instanceId</td>
<td>The instance id registered for service</td>
<td>computed</td>
</tr>
<tr>
<td>tags</td>
<td>The list of tags used when registering a service</td>
<td>none</td>
</tr>
<tr>
<td>defaultQueryTag</td>
<td>Tag to query for in service list if one is not listed in serverListQueryTags</td>
<td>none</td>
</tr>
<tr>
<td>queryPassing</td>
<td>Enable or disable whether to add the 'passing' parameter to health requests. This pushes health check passing to the server.</td>
<td>false</td>
</tr>
<tr>
<td>registerHealthCheck</td>
<td>Enable or disable health check registration</td>
<td>true</td>
</tr>
<tr>
<td>healthCheckUrl</td>
<td>The health check URL override</td>
<td>none</td>
</tr>
<tr>
<td>healthCheckPath</td>
<td>Alternate server health check path</td>
<td>'/actuator/health'</td>
</tr>
<tr>
<td>healthCheckInterval</td>
<td>How often to perform the health check</td>
<td>10s</td>
</tr>
<tr>
<td>healthCheckTimeout</td>
<td>Timeout for health check</td>
<td>10s</td>
</tr>
<tr>
<td>healthCheckCriticalTimeout</td>
<td>Timeout to de-register services critical for longer than this value</td>
<td>30m</td>
</tr>
<tr>
<td>healthCheckTlsSkipVerify</td>
<td>Health check verifies TLS</td>
<td>true</td>
</tr>
<tr>
<td>instanceZone</td>
<td>Instance zone to use during registration</td>
<td>none</td>
</tr>
<tr>
<td>instanceGroup</td>
<td>Instance group to use during registration</td>
<td>none</td>
</tr>
<tr>
<td>defaultZoneMetadataName</td>
<td>Metadata tag name of the zone</td>
<td>'zone'</td>
</tr>
<tr>
<td>failFast</td>
<td>Throw exception if registration fails</td>
<td>true</td>
</tr>
<tr>
<td>retry:enabled</td>
<td>Enable or disable retry logic</td>
<td>false</td>
</tr>
<tr>
<td>retry:maxAttempts</td>
<td>Max retries if retry enabled</td>
<td>6</td>
</tr>
<tr>
<td>retry:initialInterval</td>
<td>Starting interval</td>
<td>1000ms</td>
</tr>
<tr>
<td>retry:maxInterval</td>
<td>Maximum retry interval</td>
<td>2000ms</td>
</tr>
<tr>
<td>retry:multiplier</td>
<td>Retry interval multiplier</td>
<td>1.1</td>
</tr>
<tr>
<td>heartbeat:enabled</td>
<td>Enable or disable heartbeat logic</td>
<td>false</td>
</tr>
<tr>
<td>heartbeat:ttlValue</td>
<td>Time to live heartbeat time</td>
<td>30</td>
</tr>
<tr>
<td>heartbeat:ttlUnit</td>
<td>Time to live heartbeat unit</td>
<td>s</td>
</tr>
<tr>
<td>heartbeat:intervalRation</td>
<td>The interval ration</td>
<td>2.0/3.0</td>
</tr>
</tbody>
</table>
<h3 id="enable-logging">Enable Logging</h3>
<p>Sometimes, it is desirable to turn on debug logging. To do that simply add the following to your <code>appsettings.json</code>:</p>
<pre><code class="language-json">{
  &quot;Logging&quot;: {
    &quot;IncludeScopes&quot;: false,
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Steeltoe&quot;:  &quot;Debug&quot;
    }
  }
}
</code></pre>
<h3 id="health-contributor">Health Contributor</h3>
<p>The Consul package provides a Steeltoe Management Health contributor (<code>ConsulHealthContributor</code>) that can be used to monitor Consul server health.</p>
<p>If you use the <code>AddDiscoveryClient()</code> extension method and you have configured Consul as your service discovery choice this contributor is automatically added to the container and will automatically picked up an used.</p>
<h3 id="configuring-health-check">Configuring Health Check</h3>
<p>The health check for a Consul service instance defaults to <code>/actuator/health</code>, which is a good default when you have enabled the Steeltoe Management features in your application. You can change this path and provide your own implementation using the <code>consul:discovery:healthCheckPath</code> setting. Additionally, the interval that Consul uses to check the health endpoint may also be configured. You can change this setting using the <code>consul:discovery:healthCheckInterval</code>. You should use settings such as &quot;10s&quot; and &quot;1m&quot; to represent 10 seconds and 1 minute respectively.</p>
<h3 id="configuring-metadata">Configuring Metadata</h3>
<p>Consul does not yet support including metadata with service instance registrations, but the Steeltoe <code>IServiceInstance</code> has an <code>IDictionary&lt;string, string&gt; Metadata</code> property that is used to obtain metadata settings for an instance.</p>
<p>The Steeltoe Consul client uses the Consul tags feature to approximate metadata registration until Consul officially supports associating metadata with instances.</p>
<p>Tags with the form <code>key=value</code> will be split and used as <code>IDictionary</code> keys and values respectively. Tags without the equal sign will be used as both the key and value. You can add metadata with the <code>consul:discovery:tags</code> string array:</p>
<pre><code class="language-json">{
  &quot;consul&quot;: {
    &quot;discovery&quot;: {
      &quot;tags&quot;: [
        &quot;somekey=somevalue&quot;,
        &quot;someothervalue&quot;
      ]
    }
  }
}
</code></pre>
<p>The above tag list results in metadata that looks like this:</p>
<pre><code class="language-json">{
  &quot;somekey&quot;: &quot;somevalue&quot;,
  &quot;someothervalue&quot;: &quot;someothervalue&quot;
}
</code></pre>
<h3 id="configuring-instanceid">Configuring InstanceId</h3>
<p>By default, if no other values are configured, a Consul service instance is registered with an ID that is equal to the applications name concatenated with a random value.</p>
<p>You can change that by configuring the setting <code>spring:application:instance_id</code> or <code>vcap:application:instance_id</code> to some value and then the ID will be equal to the applications name concatenated with that value.  Note that on Cloud Foundry, <code>vcap:application:instance_id</code> will automatically be set for you if you use the Steeltoe Cloud Foundry configuration provider.</p>
<p>You can completely override all of the above by setting <code>consul:discovery:instanceId</code> to some value instead.</p>
